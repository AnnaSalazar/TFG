---
title: "Anàlisi descriptiva"
author: "Anna Salazar"
date: "`r Sys.Date()`"
output: pdf_document
header-includes:
- \pagenumbering{gobble}
- \usepackage{subfig}
editor_options:
  markdown:
    wrap: 72
---
\vspace{130mm}

<left>
![](~/Documents/GitHub/01_02_/Imatges portada/fme.png){width="50%"}
</left> <right>
![](~/Documents/GitHub/01_02_/Imatges portada/UB.png){width="50%"}
</right> \newpage

\tableofcontents

\pagebreak

\pagenumbering{arabic}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#install.packages("bigrquery")
library(bigrquery)
library(kableExtra)
library(DBI)
library(knitr)
library(dplyr)
library(VIM)
library(tidyverse)
library(summarytools)
library(reshape2)
library(ggplot2)
library(devtools)
library(naniar)
library(knitr)


projecte <- "level-oxygen-353005"

dades <- dbConnect(
  bigrquery::bigquery(),
  project = projecte,
  dataset = "examen_final",
  billing = projecte
)
```


# Descripció de la base de dades

La base de dades està formada per les següents tres taules:

**accident** és un llistat d’accidents de tràfic ocorreguts al desembre de 2015 als Estats Units:

- ST_CASE: codi de l’accident (PK)

- DAY: dia de l’accident (de l’1 al 31)

- HOUR: hora de l’accident (99 = desconeguda)

- MINUTE: minut de l’accident (99 = desconegut)

- RUR_URB: informació sobre la localització (1 = Rural, 2 = Urbà, 6 = Via no classificada, 8 = No registrat, 9 = Desconegut)

- DAY_WEEK: dia de la setmana (1 = Diumenge, 2 = Dilluns, ..., 7 = Dissabte)

- FATALS: nombre de ferits a l’accident

- DRUNK_DR: nombre de conductors beguts involucrats a l’accident

**person** és un llistat de totes les persones (conductors, passatgers o vianants) involucrades als accidents

- ST_CASE: codi de l’accident al qual està involucrada la persona (PK)

- PER_NO: número de persona dins de cada accident (PK)

- AGE: edat de la persona (998 = No registrada, 999 = Desconeguda)

- SEX:  sexe de la persona (1 = home, 2 = dona, 8 = No registrat, 9 = Desconegut)

- PER_TYP: tipus de persona (1 = conductor, 2 = ocupant, resta de codis = altres)

- DOA: tipus de víctima (0 = sobreviu, 7 = mort a l’accident, 8 = mort al trasllat, 9 = Desconegut)
	
**vehicle** és un llistat de tots els vehicles involucrats als accidents

- ST_CASE: codi de l’accident al qual està involucrat el vehicle (PK)

- VEH_NO: número de vehicle dins de cada accident (PK)

- HIT_RUN: identificador de vehicle fugit (0 = No, 1 = Sí, 9 = Desconegut)

- TRAV_SP: velocitat estimada (mph)* del vehicle quan va tenir l’accident (997,998 i 999 = Desconegut)

- PREV_SP: indicador d’existència de límit de velocitat permesa just abans de l’accident (997,998 i 999 = Desconegut)

*mph vol dir milles per hora. 100 mph=161 Km/h

\pagebreak

# Anàlisi univariant

## Variables categòriques

```{r echo=FALSE}
descriptiva <- function(X, nom,dades){
  if (!(is.numeric(X) || class(X) == "Date")){ 
    frecs <- table(as.factor(X), useNA = "no"); proportions <- frecs/n
    dataf <- data.frame(x = levels(as.factor(X)), y = frecs)
    par(mfrow=c(1,2))
    print(ggplot(dataf, aes(x = "", y = frecs, fill = x)) + 
            geom_bar(stat = "identity", width = 1) + 
            scale_y_continuous(expand = c(0,0)) + coord_polar("y", start = 0) + 
            theme_minimal())
    print(ggplot(dataf, aes(x = x, y=frecs)) + geom_bar(stat = "identity", 
          color = "lightblue", fill = "lightblue") + 
            scale_y_continuous(expand = c(0,0)) + theme_void())
    x <- data.frame(X)
    colnames(x) <- nom
    st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = FALSE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
    dfSummary(x) 

   }else{
      print(ggplot(dades, aes(x = X)) + geom_bar(col = "lightblue", fill = 
      "lightblue") + theme_minimal())
       a <- descr(X, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", 
                 "mean", "sd", "q3", "max", "iqr"), style = "rmarkdown", justify 
                 = "center")
       rownames(a) <- NULL
       kable(a, caption = paste("Resum numèric de la variable", nom), 
             format = "latex", position = "h!")
   }
}

descriptiva2 <- function(X, nom,dades){
  if (!(is.numeric(X) || class(X) == "Date")){ 
    frecs <- table(as.factor(X), useNA = "no"); proportions <- frecs/n
    dataf <- data.frame(x = levels(as.factor(X)), y = frecs)
    par(mfrow=c(1,2))
    print(ggplot(dataf, aes(x = "", y = frecs, fill = x)) + 
            geom_bar(stat = "identity", width = 1) + 
            scale_y_continuous(expand = c(0,0)) + coord_polar("y", start = 0) + 
            theme_minimal())
    print(ggplot(dataf, aes(x = x, y=frecs)) + geom_bar(stat = "identity", 
          color = "lightblue", fill = "lightblue") + 
            scale_y_continuous(expand = c(0,0)) + theme_void())
   }else{
      print(ggplot(dades, aes(x = X)) + geom_bar(col = "lightblue", fill = 
      "lightblue") + theme_minimal())
       a <- descr(X, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", 
                 "mean", "sd", "q3", "max", "iqr"), style = "rmarkdown", justify 
                 = "center")
       rownames(a) <- NULL
       kable(a, caption = paste("Resum numèric de la variable", nom), 
             format = "latex", position = "h!")
   }
}
```

```{r, warning=FALSE, message=FALSE}
bd <- data.frame(dbGetQuery(dades, 
          "SELECT * FROM `level-oxygen-353005.examen_final.person` AS B
 LEFT JOIN (SELECT T.*, HIT_RUN, TRAV_SP, PREV_SP
            FROM (SELECT A.*, COUNT(C.ST_CASE) AS NO_VEHICLES
                  FROM (SELECT `level-oxygen-353005.examen_final.accident`.*, 
                  COUNT(B1.ST_CASE) AS NO_PER
                        FROM `level-oxygen-353005.examen_final.accident` 
                              INNER JOIN 
                              `level-oxygen-353005.examen_final.person` AS B1
                        ON `level-oxygen-353005.examen_final.accident`.ST_CASE = B1.ST_CASE
                        GROUP BY `level-oxygen-353005.examen_final.accident`.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK, FATALS, DRUNK_DR) AS A 
                      INNER JOIN `level-oxygen-353005.examen_final.vehicle` AS C
                      ON A.ST_CASE = C.ST_CASE
                      GROUP BY A.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK, FATALS, DRUNK_DR, NO_PER) AS T INNER JOIN `level-oxygen-353005.examen_final.vehicle` AS C2
                      ON T.ST_CASE = C2.ST_CASE) AS T2
          ON B.ST_CASE = T2.ST_CASE"))
bd <- bd[,-c(1, 2, 7)]
n <- nrow(bd)

bd <- data.frame(bd)
for(i in c(2, 3, 4, 5, 8, 9, 14, 16)) {
  bd[,i]<-as.factor(bd[,i])
}
```


## Tractament de les dades mancants

### Variables numèriques

```{r}
bd <- bd %>% replace_with_na(replace = list(TRAV_SP = c(997, 998, 999)))
bd <- bd %>% replace_with_na(replace = list(AGE = c(998, 999)))
bd <- bd %>% replace_with_na(replace = list(MINUTE = c(99)))
bd <- bd %>% replace_with_na(replace = list(HOUR = c(99)))

sum(is.na(bd$TRAV_SP))/n*100
sum(is.na(bd$AGE))/n*100
sum(is.na(bd$MINUTE))/n*100
sum(is.na(bd$HOUR))/n*100
```


## Variables qualitatives

```{r}
levels(bd$PER_TYP) <- c("Conductor", "Ocupant", "Altres", "Altres", "Altres", 
                        "Altres", "Altres", "Altres")
levels(bd$HIT_RUN) <- c("No", "Sí", "Desconegut")
levels(bd$PREV_SP) <- c("0", "1", "2", "3", "4", "5", "7", "9", "Desconegut", 
                        "Desconegut")
levels(bd$DAY_WEEK) <- c("Diumenge", "Dilluns", "Dimarts", "Dimecres", "Dijous",
                         "Divendres", "Dissabte")
levels(bd$SEX) <- c("Home", "Dona", "No registrat", "Desconegut")
levels(bd$RUR_URB) <- c("Rural", "Urbà", "Via no classificada", 
                        "No registrat", "Desconegut")
levels(bd$DOA) <- c("Sobreviu", "Mort a l'accident", "Mort al trasllat", 
                    "Desconegut")
```

**Dia de l'accident**

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Dia", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva2(bd[,5], colnames(bd)[5], dades = bd)
```

**Hora de l'accident**

```{r echo=FALSE, out.width="50%", fig.align = 'center', comment = "", fig.cap=c("Histograma de la variable Hora de l'accident"), results='asis', warning=FALSE}
descriptiva(bd[,6], "Hora de l'accident", dades = bd)
```

\pagebreak

**Minut de l'accident**

```{r echo=FALSE, out.width="50%", fig.align = 'center', comment = "", fig.cap=c("Histograma de la variable Minut de l'accident"), results='asis', warning=FALSE}
descriptiva(bd[,7], "Minut de l'accident", dades = bd)
```

**Localització**

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Localització", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(bd[,8], "Localització", dades = bd)
```

\pagebreak

**Dia de la setmana**

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Dia de la setmana", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(bd[,9], "Dia de la setmana", dades = bd)
```

**Nombre de ferits a l’accident**

```{r echo=FALSE, out.width="50%", fig.align = 'center', comment = "", fig.cap=c("Histograma de la variable Nombre de ferits a l’accident"), results='asis', warning=FALSE}
descriptiva(bd[,10], "Nombre de ferits a l’accident", dades = bd)
```

\pagebreak

**Nombre de conductors beguts**

```{r echo=FALSE, out.width="50%", fig.align = 'center', comment = "", fig.cap=c("Histograma de la variable Nombre de conductors beguts"), results='asis', warning=FALSE}
descriptiva(bd[,11], "Nombre de conductors beguts", dades = bd)
```

\pagebreak


**Nombre de persones implicades en l'accident**

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Nombre de la persona", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(bd[,12], "Nombre de persones implicades en l'accident", dades = bd)
```

\pagebreak

**Edat**

```{r echo=FALSE, out.width="50%", fig.align = 'center', comment = "", fig.cap=c("Histograma de la variable Edat"), results='asis', warning=FALSE}
descriptiva(bd[,1], "Edat", dades = bd)
```

\pagebreak

**Sexe**

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Sexe", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(bd[,2], "Sexe", dades = bd)
```

\pagebreak

**Tipus de persona**

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Tipus de persona", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(bd[,3], "Tipus de persona", dades = bd)
```

**Tipus de víctima**

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Tipus de víctima", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(bd[,4], "Tipus de víctima", dades = bd)
```

\pagebreak


**Nombre de vehicles involucrats en l'accident**

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Nombre de vehicles involucrats en l'accident", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(bd[,13], "Nombre de vehicles involucrats en l'accident", dades = bd)
```

**Identificació del vehicle**

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Identificació del vehicle", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(bd[,14], "Identificació del vehicle", dades = bd)
```

**Velocitat estimada**

```{r echo=FALSE, out.width="50%", fig.align = 'center', comment = "", fig.cap=c("Histograma de la variable Velocitat estimada"), results='asis', warning=FALSE}
descriptiva(bd[,15], "Velocitat estimada", dades = bd)
```

**Indicador d’existència de límit de velocitat permesa just abans de l’accident**

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Indicador d’existència de límit de velocitat", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(bd[,16], "Indicador d’existència de límit de velocitat permesa just abans de l’accident", dades = bd)
```

## Variables numèriques

