---
title: "Anàlisi descriptiva"
author: "Anna Salazar"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  bookdown::pdf_document2: default
  bookdown::html_document2: default
header-includes:
- \pagenumbering{gobble}
- \usepackage{subfig}
- \usepackage[labelsep=period]{caption}
- \usepackage[labelfont=bf]{caption}
- \usepackage{floatrow}
editor_options:
  markdown:
    wrap: 72
---
\vspace{130mm}

<left>
![](~/Documents/GitHub/TFG/Imatges portada/fme.png){width="50%"}
</left> <right>
![](~/Documents/GitHub/TFG/Imatges portada/UB.png){width="50%"}
</right> 
\newpage

\renewcommand{\contentsname}{Índex}
\renewcommand{\figurename}{Figura}
\renewcommand{\tablename}{Taula}
\floatsetup[table]{capposition=bottom}
\floatsetup[figure]{capposition=bottom}
\captionsetup{width=.75\textwidth}
\tableofcontents

\pagebreak

\pagenumbering{arabic}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
x <- c("bigrquery", "kableExtra", "DBI", "knitr", "dplyr", "VIM", "tidyverse", "summarytools", "reshape2", "ggplot2", "devtools", "naniar", "forcats", "sqldf", "factoextra")

lapply(x, require, character.only = TRUE)

projecte <- "level-oxygen-353005"

dades <- dbConnect(
  bigrquery::bigquery(),
  project = projecte,
  dataset = "examen_final",
  billing = projecte
)
```


# Descripció de la base de dades

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
#A <- data.frame(dbGetQuery(dades, "SELECT * FROM `level-oxygen-353005.examen_final.accident2`"))
#B <- data.frame(dbGetQuery(dades, "SELECT * FROM `level-oxygen-353005.examen_final.person`"))
#C <- data.frame(dbGetQuery(dades, "SELECT * FROM `level-oxygen-353005.examen_final.vehicle`"))
A <- data.frame(read.csv2("/Users/annasalazar/Documents/GitHub/TFG/Dades originals/accident.csv", sep = ";"))
B <- data.frame(read.csv2("/Users/annasalazar/Documents/GitHub/TFG/Dades originals/person.csv", sep = ";"))
C <- data.frame(read.csv2("/Users/annasalazar/Documents/GitHub/TFG/Dades originals/vehicle.csv", sep = ";"))
C$HIT_RUN[C$HIT_RUN==9] <- 0 
B$MORT == 0
B$MORT[B$DOA==7 | B$DOA==8 ] <- 1 
```

Les bases de dades que seran utilitzades al llarg de l'estudi provenen de l'agència estatal de trànsit dels Estats Units i contenen tres taules, entre les quals s'hi troba un llistat d’accidents de tràfic ocorreguts al desembre de 2015 als Estats Units, juntament amb un recompte de totes les persones (conductors, passatgers o vianants) involucrades als accidents i, finalment, un inventari de tots els vehicles involucrats als accidents. 

L'enllaç a la base esmentada és el següent: 

<https://www.transportation.gov/briefing-room/traffic-fatalities-sharply-2015>


Més concretament, en cada taula es poden trobar les variables següents:

**Accident** és un llistat d’accidents de trànsit ocorreguts al desembre de 2015 als Estats Units.

| Variable           | Tipus         | Descripció                                                                                                        |
|--------------------|---------------|-------------------------------------------------------------------------------------------------------------------|
| ST_CASE            | Categòrica    | Codi de l’accident                                                                                                |
| DAY                | Categòrica    | Dia de l’accident (de l’1 al 31)                                                                                  |
| HOUR               | Numèrica      | Hora de l’accident (99 = desconeguda)                                                                             |
| MINUTE             | Numèrica      | Minut de l’accident (99 = desconegut)                                                                             |
| RUR_URB            | Categòrica    | Informació sobre la localització (1 = Rural, 2 = Urbà, 6 = Via no classificada, 8 = No registrat, 9 = Desconegut) |
| DAY_WEEK           | Categòrica    | Dia de la setmana (1 = Diumenge, 2 = Dilluns, ..., 7 = Dissabte)                                                  |
| FATALS             | Numèrica      | Nombre de ferits a l’accident                                                                                     |
| DRUNK_DR           | Numèrica      | Nombre de conductors beguts involucrats a l’accident                                                              |
: Llistat de variables de la taula Accident

**Person** és un llistat de totes les persones (conductors, passatgers o vianants) involucrades als accidents.

| Variable           | Tipus         | Descripció                                                                                                        |
|--------------------|---------------|-------------------------------------------------------------------------------------------------------------------|
| ST_CASE            | Categòrica    | Codi de l’accident al qual està involucrada la persona                                                            |
| PER_NO             | Categòrica    | Nombre de la persona dins de cada accident                                                                        |
| AGE                | Numèrica      | Edat de la persona (998 = No registrada, 999 = Desconeguda)                                                       |
| SEX                | Categòrica    | Sexe de la persona (1 = home, 2 = dona, 8 = No registrat, 9 = Desconegut)                                          |
| PER_TYP            | Categòrica    | Tipus de persona (1 = conductor, 2 = ocupant, resta de codis = altres)                                            |
| DOA                | Categòrica    | Tipus de víctima (0 = sobreviu, 7 = mort a l’accident, 8 = mort al trasllat, 9 = Desconegut)                |

: Llistat de variables de la taula Person

**Vehicle** és un llistat de tots els vehicles involucrats als accidents.


| Variable           | Tipus         | Descripció                                                                                                        |
|--------------------|---------------|-------------------------------------------------------------------------------------------------------------------|
| ST_CASE            | Categòrica    | Codi de l’accident al qual està involucrat el vehicle                                                             |
| NO_VEH             | Numèrica      | Nombre de vehicles implicats en l'accident                                                                        |
| HIT_RUN            | Categòrica    | Identificador de vehicle fugit (0 = No, 1 = Sí, 9 = Desconegut)                                                   |
| TRAV_SP            | Numèrica      | Velocitat estimada (mph) del vehicle quan va tenir l’accident (997,998 i 999 = Desconegut)                        |
| PREV_SP            | Categòrica    | Indicador d’existència de límit de velocitat permesa just abans de l’accident (997,998 i 999 = Desconegut)  |

: Llistat de variables de la taula Vehicle




## Objectius del projecte

Estudiant aquesta base de dades sobre persones que s'han vist implicades, de forma directa o indirecta, en accidents de trànsit es preten:

- Descriure els tipus d'accidents que estan registrats

- Analitzar els diferents perfils de persones que pateixen accidents de trànsit

- Desenvolupar un model de predicció que ens permeti establir el tipus de víctima que serà cada persona depenent les característiques de l'accident i els vehicles. 

- Estudiar les relacions de dependència entre variables

\pagebreak

# Lectura de les dades

A partir d'aquestes tres taules, s'extreuran dues bases de dades a partir de les quals es treballarà al llarg del projecte.

En primer lloc, es tindrà en compte la informació dels accidents. D'aquesta manera es podrà estudiar les característiques dels diferents accidents regitrats, així com es podran fer prediccions sobre els nous accidents en funció de les seves característiques. S'ha anomenat aquesta base `accident`, i està conformada per les variables següents: DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK, FATALS, DRUNK_DR, NO_PER, MORTS, NO_VEHICLE, HIHAMORTS.

Les variables **MORTS**, **NO_PER**, **NO_VEHICLE** i **HIHAMORTS** han sigut creades a posteriori a partir de les taules de les que es disposava, i es defineixen a continuació:

| Variable            | Tipus         | Descripció                                                                                                      |
|---------------------|---------------|------------------------------------------------------------------------------------------------------------------|
| MORTS               | Numèrica      | Nombre de morts en l'accident                                                                                   |
| NO_PER              | Numèrica      | Nombre de persones implicades en l'accident                                                                     |
| NO_VEHICLE          | Numèrica      | Nombre de vehicles implicats en l'accident                                                                      |
| HIHAMORTS           | Categòrica    | Variable identificadora dels accidents mortals (0: no hi ha morts en l'accident, 1: hi ha morts en l'accident)|

: Llistat de variables definides a posteriori per a la taula Accidents

```{r}
# Nombre de persones per accident
query11 <- sqldf("SELECT DISTINCT A.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK,
                                 FATALS, DRUNK_DR, COUNT(B.ST_CASE) AS NO_PER, SUM(MORT) AS MORTS
                        FROM B INNER JOIN  A 
                        ON A.ST_CASE = B.ST_CASE
                        GROUP BY A.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK,
                                 FATALS, DRUNK_DR")

query11$MORTS[is.na(query11$MORTS)] <- 0

# Nombre de vehicles per accident
query12 <- sqldf("SELECT DISTINCT A.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK,
                                 FATALS, DRUNK_DR, COUNT(C.ST_CASE) AS NO_VEHICLE
                        FROM C INNER JOIN  A 
                        ON A.ST_CASE = C.ST_CASE
                        GROUP BY A.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK,
                                 FATALS, DRUNK_DR")


# Ajuntem l'accident amb el nombre de persones i el nombre de vehicles
accidents <- sqldf("SELECT query11.*, NO_VEHICLE
                        FROM query11 INNER JOIN  query12 
                        ON query11.ST_CASE = query12.ST_CASE")
accident <- accidents[,-1]

accident$HIHAMORTS = 0
accident$HIHAMORTS[accidents$MORTS>0] <- 1

accident <- data.frame(accident)
for(i in c(1, 4, 5, 11)) {
  accident[,i]<-as.factor(accident[,i])
}
```


D'altra banda, s'estudiarà la informació sobre les persones implicades en aquests accidents. D'aquesta manera es podrà perfilar el tipus de conductors en els casos en que hi hagi morts en l'accident, així com en els que no hi hagi. Aquesta informació també ens facilitarà l'elaboració de possibles models per predir el tipus de víctima que serà una persona involucrada en un accident de trànsit en base a les seves característiques. en aquest cas, s'ha anomenat aquesta base `persones`, i està conformada per les variables següents: DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK, FATALS, DRUNK_DR, NO_PER, MORTS, NO_VEHICLE, NO_FUGITS, AGE, SEX, PERTYP i DOA.

Las variable **NO_FUGITS** ha sigut creada a posteriori a partir de les taules de les que es disposava, i es defineix a continuació:

| Variable           | Tipus         | Descripció                                                                                                        |
|--------------------|---------------|-------------------------------------------------------------------------------------------------------------------|
| NO_FUGITS          | Numèrica      | Nombre de vehicles fugits implicats en l'accident                                                                 |
: Llistat de variables definides a posteriori per a la taula Persones

```{r}
# Ajuntem l'accident amb els vehicles
query3 <- sqldf("SELECT accidents.*, SUM(HIT_RUN) AS NO_FUGITS
                        FROM accidents INNER JOIN  C 
                        ON accidents.ST_CASE = C.ST_CASE
                GROUP BY accidents.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK,
                                 FATALS, DRUNK_DR
                HAVING HIT_RUN <> 9")

# Ajuntem l'accident amb les persones
query4 <- sqldf("SELECT query3.*, AGE, SEX, PER_TYP, DOA
                        FROM query3 INNER JOIN  B 
                        ON query3.ST_CASE = B.ST_CASE")
persones <- query4[,-1]
n <- nrow(persones)
persones <- data.frame(persones)
for(i in c(1, 4, 5, 13, 14, 15)) {
  persones[,i]<-as.factor(persones[,i])
}
```


# Preprocessament

La base de dades d'accidents està formada per `r nrow(accident)` casos (accidents) i `r ncol(accident)` variables. En canvi, la base de dades de persones la conformen `r nrow(persones)` individus (files) i `r ncol(persones)` variables (columnes).

Les variables que tenim són DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK, FATALS, DRUNK_DR, NO_PER, MORTS, NO_VEHICLE, HIHAMORTS, NO_FUGITS, AGE, SEX, PERTYP i DOA.

## Missings

Per a poder tractar les dades mancants de la base de dades, en primer lloc haurem de tranformar-les, ja que les variables que presenten dades mancants les tenen codificades.

En el cas de les variables numèriques amb *missings*, que són l'edat (AGE), l'hora (HOUR), el minut (MINUTE) i la velocitat estimada del vehicle quan va tenir l'accident (TRAV_SP), les codificacions per aquestes dades són 99, 997, 998 o 999, depenent de cada cas.

```{r}
# Variable AGE
persones <- persones %>% replace_with_na(replace = list(AGE = c(998, 999)))

# Variable MINUTE
persones <- persones %>% replace_with_na(replace = list(MINUTE = c(99)))
accident <- accident %>% replace_with_na(replace = list(MINUTE = c(99)))

# Variable HOUR
persones <- persones %>% replace_with_na(replace = list(HOUR = c(98, 99)))
accident <- accident %>% replace_with_na(replace = list(HOUR = c(98, 99)))
```

Un cop transformades aquestes dades, podem visualitzar a la taula següent els *missings* per cada variable numèrica, tant en terme absolut com relatiu. A la taula següent s'hi poden trobar les variables de les bases de dades d'accidents i de persones, respectivament, juntament amb el nombre de dades mancants que presenten, i el tant per cent que aquestes suposen al total de la informació de la variable.

```{r, out.width = "50%", results='asis'}
propmiss <- function(dataframe) lapply(dataframe,function(x) data.frame(na = sum(is.na(x)),
                    n = length(x),  propNA = round(sum(is.na(x))/length(x),4) * 100))

missingsa <- propmiss(accident)
missingsa <- do.call(rbind.data.frame, missingsa)
missingsa <- missingsa[,-2]
colnames(missingsa) <- c("NA","Percentatge de NA")

missingsp <- propmiss(persones)
missingsp <- do.call(rbind.data.frame, missingsp)
missingsp <- missingsp[,-2]
colnames(missingsp) <- c("NA","Percentatge de NA")


knitr::kables(
  list(
    knitr::kable(missingsa), 
    knitr::kable(missingsp)), 
  caption = "Percentatge de missings per variable", format="latex")
```

Tal i com es pot observar, a la base de dades d'accidents s'hi troben *missings* per a les variables `HOUR` i `MINUTES`, mentre que per a la base de dades de persones, s'hi troben missings per a les variables `HOUR`, `MINUTES` i `AGE`. En ambdós casos, totes les variables són numèriques i, per aquest motiu es pot usar l'algoritme KNN per a la imputació de valors a les dades mancants.

*K-nearest neighbors* (KNN) és un tipus d'algoritme d'aprenentatge supervisat que s'utilitza tant per a la regressió com per a la classificació. La seva funció és intentar predir la classe correcta per a unes dades de prova (que, en el nostre cas, seran les variables que presenten dades mancants) en base a la seva similitut amb altres mostres de dades conegudes (en el nostre cas, les variables completes). Tot això es fa assumint que les dades amb trets similars es troben juntess, i utilitza mesures de distància en el seu nucli.

```{r include=FALSE}
library(class)
fullVariables<-c(6,7,8,9,10)
aux<-accident[,fullVariables]
var_num_incompletes <- c(2,3)
for (k in var_num_incompletes){
  aux1 <- aux[!is.na(accident[,k]),]
  dim(aux1) 
  aux2 <- aux[is.na(accident[,k]),]
  dim(aux2)
  
  RefValues<- accident[!is.na(accident[,k]),k]
  
  knn.values = knn(aux1,aux2,RefValues)   
  accident[is.na(accident[,k]),k] = as.numeric(as.character(knn.values))
  fullVariables<-c(fullVariables, k)
  aux<-accident[,fullVariables]
}
```

```{r include=FALSE}
library(class)
fullVariables<-c(6,7,8,9,10,11)
aux<-persones[,fullVariables]
var_num_incompletes <- c(2,3,12)
for (k in var_num_incompletes){
  aux1 <- aux[!is.na(persones[,k]),]
  dim(aux1) 
  aux2 <- aux[is.na(persones[,k]),]
  dim(aux2)
  
  RefValues<- persones[!is.na(persones[,k]),k]
  
  knn.values = knn(aux1,aux2,RefValues)   
  persones[is.na(persones[,k]),k] = as.numeric(as.character(knn.values))
  fullVariables<-c(fullVariables, k)
  aux<-persones[,fullVariables]
}
```

Un cop s'ha aplicat l'algoritme per a les variables corresponents, es pot veure, a continuació, com cap de les dues bases de dades presenta cap missing a les variables conflictives.

Recordem que la taula mostra les bases de dades d'accidents i de les persones implicades en els accidents, respectivament:

```{r, out.width = "50%", results='asis'}

propmiss <- function(dataframe) lapply(dataframe,function(x) data.frame(na = sum(is.na(x)),
                    n = length(x),  propNA = round(sum(is.na(x))/length(x),4) * 100))

missingsa <- propmiss(accident[,c(2,3)])
missingsa <- do.call(rbind.data.frame, missingsa)
missingsa <- missingsa[,-2]
colnames(missingsa) <- c("NA","Percentatge de NA")

missingsp <- propmiss(persones[c(2,3,12)])
missingsp <- do.call(rbind.data.frame, missingsp)
missingsp <- missingsp[,-2]
colnames(missingsp) <- c("NA","Percentatge de NA")

knitr::kables(
  list(
    knitr::kable(
           missingsa), 
    knitr::kable(
           missingsp)
    ), 
  caption = "Percentatge de missings per variable després del KNN", format="latex") %>%
  kable_styling(latex_options = "HOLD_position")

```

\pagebreak

## Outliers

```{r echo=FALSE}
descriptiva <- function(X, nom,dades){
  if (!(is.numeric(X) || class(X) == "Date")){ 
    frecs <- table(as.factor(X), useNA = "no"); proportions <- frecs/n
    dataf <- data.frame(x = levels(as.factor(X)), y = frecs)
    par(mfrow=c(1,2))
    print(ggplot(dataf, aes(x = "", y = frecs, fill = x)) + 
            geom_bar(stat = "identity", width = 1) + 
            scale_y_continuous(expand = c(0,0)) + coord_polar("y", start = 0) +
            scale_fill_brewer(palette = "YlGnBu") +
            theme_minimal())
    print(ggplot(dataf, aes(x = x, y=frecs)) + geom_bar(stat = "identity", 
          color = "#1d91c0", fill = "#1d91c0") + 
            scale_y_continuous(expand = c(0,0)) + theme_void())
    x <- data.frame(X)
    colnames(x) <- nom
    st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = FALSE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
    dfSummary(x) 

   }else{
      par(mfrow=c(1,2))
      print(ggplot(dades, aes(x = X)) + geom_bar(col = "#1d91c0", fill = 
      "#1d91c0") + theme_minimal())
#      print(ggplot(dades, aes(y = X)) + geom_boxplot(col = "#1d91c0", outlier.colour="red", outlier.shape=8,
#       outlier.size=4) + theme_minimal())
       a <- descr(X, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", 
                 "mean", "sd", "q3", "max", "iqr"), style = "rmarkdown", justify 
                 = "center")
       rownames(a) <- NULL
       kable(a, caption = paste("Resum numèric de la variable", nom), 
             format = "latex", position = "h!")
   }
}
```

Pel que fa a les dades atípiques, en destaca el nombre de persones implicades a l'accident. Més específicament, hi ha un cas en que 53 persones estan involucrades en un accident. A priori, res ens fa pensar que aquesta dada, tot i ser atípica, sigui certa. Això no obstant, a l'hora de la segmentació les dades es podrien veure afectades per aquest valor, ja que alguns algoritmes són molt sensibles a les dades atípiques.

A la següent figura es representa la variable nombre de persones (NO_PER), on es poden identificar de forma clara aquests valors atípics:

```{r, out.width="50%", fig.cap= "Histograma de la variable Nombre de persones", results='asis'}
#par(mfrow=c(1,2))
descriptiva(persones[,8], "Nombre de persones", dades = persones)
```

Per tal d'assegurar-nos que aquesta dada no afecta al nostre anàlisi, i tenint en compte que disposem d'una base de dades molt gran, treurem aquests casos d'ambdues bases de dades.

```{r, echo=FALSE, include=FALSE}
persones <- persones[persones[,8] != 53,] 
accident <- accident[accident[,8] != 53,]
```

```{r, out.width="50%", fig.cap= "Histograma de la variable Nombre de persones després d'eliminar l'outlier", results='asis'}
#par(mfrow=c(1,2))
descriptiva(persones[,8], "Nombre de persones", dades = persones)
```


## Categoritzar

En el cas de les dades mancants que es troben en variables categòriques, el que es farà serà factoritzar-les i, seguidament, definir els nivells que presenta el factor. Així, per exemple, la variable **PER_TYP** presenta $8$ nivells que s'han d'agrupar en $3$ (*Conductor*, *Ocupant* i *Altres*). 

A continuació es mostren els canvis realitzats a algunes de les variables categòriques de la base de dades:

**PER_TYP**: Tipus de persona (1 = conductor, 2 = ocupant, resta de codis = altres).

```{r}
persones$PER_TYP <- as.factor(persones$PER_TYP)
ab <- levels(persones$PER_TYP)

levels(persones$PER_TYP) <- c("Conductor", "Ocupant", "Altres", "Altres", "Altres", 
                        "Altres", "Altres", "Altres")
de <- levels(persones$PER_TYP)
```

- Abans: `r ab`

- Després: `r de`

**DAY_WEEK**: Dia de la setmana (1 = Diumenge, 2 = Dilluns, . . . , 7 = Dissabte).

```{r}
persones$DAY_WEEK <- as.factor(persones$DAY_WEEK)
ab <- levels(persones$DAY_WEEK)

levels(persones$DAY_WEEK) <- c("Diumenge", "Dilluns", "Dimarts", "Dimecres", "Dijous",
                         "Divendres", "Dissabte")

accident$DAY_WEEK <- as.factor(accident$DAY_WEEK)
levels(accident$DAY_WEEK) <- c("Diumenge", "Dilluns", "Dimarts", "Dimecres", "Dijous",
                         "Divendres", "Dissabte")

de <- levels(persones$DAY_WEEK)
```

- Abans: `r ab`

- Després: `r de`

**SEX**: Sexe de la persona (1 = home, 2 = dona, 8 = No registrat, 9 = Desconegut).

```{r}
persones$SEX <- as.factor(persones$SEX)
ab <- levels(persones$SEX)

levels(persones$SEX) <- c("Home", "Dona", "Desconegut", "Desconegut")
de <- levels(persones$SEX)
```

- Abans: `r ab`

- Després: `r de`

Per la variable variable `SEX` hi ha una categoria anomenada "Desconegut", que representa aquelles persones de les quals no tenim informació del seu sexe. Com aquesta categoria no ens aporta informació d'utilitat a l'hora de realitzar l'estudi ni per a relitzar models predictius, prescindirem dels individus que corresponguin aquesta categoria per a realitzar el nostre anàlisi.

```{r, echo=FALSE, include=FALSE}
persones <- persones[persones$SEX != "Desconegut",] 
persones$SEX <- droplevels(persones$SEX)
```

**RUR_URB**: Informació sobre la localització (1 = Rural, 2 = Urbà, 6 = Via no classificada, 8 = No registrat, 9 = Desconegut). 

```{r}
persones$RUR_URB <- as.factor(persones$RUR_URB)
accident$RUR_URB <- as.factor(accident$RUR_URB)
ab <- levels(persones$RUR_URB)

levels(persones$RUR_URB) <- c("Rural", "Urbà", "Desconegut", 
                        "Desconegut", "Desconegut")
levels(accident$RUR_URB) <- c("Rural", "Urbà", "Desconegut", 
                        "Desconegut", "Desconegut")

de <- levels(persones$RUR_URB)
```

- Abans: `r ab`

- Després: `r de`

**HI HA MORTS**: Variable identificadora dels accidents mortals (0: no hi ha morts en l'accident, 1: hi ha morts en l'accident).

```{r}
accident$HIHAMORTS <- as.factor(accident$HIHAMORTS)
ab <- levels(accident$HIHAMORTS)

levels(accident$HIHAMORTS) <- c("No", "Sí")

de <- levels(accident$HIHAMORTS)
```

- Abans: `r ab`

- Després: `r de`

**DOA**: Tipus de víctima (0 = sobreviu, 7 = mort a l’accident, 8 = mort al trasllat, 9 = Desconegut)

```{r}
persones$DOA <- as.factor(persones$DOA)
ab <- levels(persones$DOA)

levels(persones$DOA) <- c("Sobreviu", "Mor", "Mor", "Desconegut")

de <- levels(persones$DOA)
```

- Abans: `r ab`

- Després: `r de`

Per aquesta última variable, `DOA`, hi ha una categoria anomenada "Desconegut", que representa aquelles persones que no se sap si sobreviuen a l'accident o no. Ja que en aquest estudi el fet de sobreviure o no a l'accident és de gran interès, i aquesta categoria  no ens aporta informació útil, prescindirem dels individus enmarcats en aquesta categoria per a realitzar el nostre anàlisi.

```{r, echo=FALSE, include=FALSE}
persones <- persones[persones$DOA != "Desconegut",] 
persones$DOA <- droplevels(persones$DOA)
```


```{r}
lev <- c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", 
         "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25",
         "26", "27", "28", "29", "30", "31")
persones$DAY <- factor(persones$DAY, levels = lev)
accident$DAY <- factor(accident$DAY, levels = lev)
```

Per últim, es crearan dues variables noves a partir de `HOURS` i `DAY`, que ja són presents a ambdós conjunts de dades. Aquest pas es realitza perquè les variables `HOURS` i `DAY` tenen un rang de valors molt elevat que ens aporta poca informació. 

**HOURS_agrupat**

En el cas de la variable `HOURS`, es tindrà en compte que, comunament, es considera que el dia està format per 5 intervals de temps segons la posició del sol. Aquest són la matinada (de les 0 a les 5 h incloses), el matí (de les 6 a les 11 h incloses), el migdia (de les 12 a les 14 h incloses), la tarda (de les 15 a les 19 h incloses) i la nit (de les 20 a les 23 h incloses). S'han fet servir aquests intervals per definir la nova variable `HOURS_agrupat`

```{r}
accident$HOUR_agrupat<- as.factor(accident$HOUR)
ab <- levels(accident$HOUR_agrupat)

levels(accident$HOUR_agrupat) <- c("Matinada","Matinada","Matinada", "Matinada", "Matinada", "Matinada", "Matí", "Matí", "Matí", "Matí", "Matí", "Matí", "Migdia", "Migdia","Migdia","Tarda","Tarda","Tarda","Tarda","Tarda", "Nit", "Nit", "Nit", "Nit", "Nit")
de <- levels(accident$HOUR_agrupat)

persones$HOUR_agrupat <- as.factor(persones$HOUR)
levels(persones$HOUR_agrupat) <- c("Matinada","Matinada","Matinada", "Matinada", "Matinada", "Matinada", "Matí", "Matí", "Matí", "Matí", "Matí", "Matí", "Migdia", "Migdia","Migdia","Tarda","Tarda","Tarda","Tarda","Tarda", "Nit", "Nit", "Nit", "Nit", "Nit")
```

- Abans: `r ab`

- Després: `r de`


**SETMANA**

Pel que fa a la variable `SETMANA`, s'han definit les setmanes del mes en que es va realitzar el seguiment que presenten les dades. S'ha considerat el primer dia de la setmana el dilluns i l'últim el diumenge, tenint en compte que el dia 1 del mes era un dimarts. Per aquest motiu les setmanes 1 i 5 són les més curtes, especialment la cinquena, ja que el dia 31 va caure en dijous.

```{r}
accident$SETMANA <- accident$DAY
ab <- levels(accident$SETMANA)

levels(accident$SETMANA) <- c("Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 5", "Setmana 5", "Setmana 5", "Setmana 5")
de <- levels(accident$SETMANA)

persones$SETMANA <- persones$DAY
levels(persones$SETMANA) <- c("Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 5", "Setmana 5", "Setmana 5", "Setmana 5")
```

- Abans: `r ab`

- Després: `r de`


## Variable resposta

Per últim, definirem les variables resposta per a cada base de dades, és a dir, aquelles característiques que ens interessa poder predir tant en els futurs accidents com en les pròximes persones que es vegin involucrades en aquests.

Per una banda, és d'interès classificar els accidents segons si aquests han ocasionat morts o bé no ha sigut el cas. D'aquesta manera, es podria crear un model de predicció que permeti establir si un accident serà mortal o no en el futur en funció de les característiques que presenti.

Per tant, la variable d'interès és `HIHAMORTS`, que es mostra a la següent figura.

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Hi ha morts", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(accident[,11], "Hi ha morts", dades = persones)
```

\pagebreak

Seguint aquesta línia, serà també de gran importància el tipus de víctima que esdevindran cadascuna de les persones implicades en un accident. En aquest cas, la variable d'interès serà `DOA`, de la qual es pot trobar un breu anàlisi descriptiu a la figuara següent.

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Tipus de víctima", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(persones[,15], "Tipus de víctima", dades = persones)
```


```{r, echo=FALSE}
write.csv(accident,"/Users/annasalazar/Documents/accidents_bd.csv", row.names = FALSE)
write.csv(persones,"/Users/annasalazar/Documents/persones_bd.csv", row.names = FALSE)
```


\pagebreak

# Anàlisi descriptiva univariant

## Variables numèriques 

### Variables vinculades als accidents

| Variable            | Tipus         | Descripció                                                                                                      |
|---------------------|---------------|------------------------------------------------------------------------------------------------------------------|
| HOUR               | Numèrica      | Hora de l’accident (99 = desconeguda)                                                                             |
| MINUTE             | Numèrica      | Minut de l’accident (99 = desconegut)                                                                             |
| FATALS             | Numèrica      | Nombre de ferits a l’accident                                                                                     |
| DRUNK_DR           | Numèrica      | Nombre de conductors beguts involucrats a l’accident                                                              |
| MORTS               | Numèrica      | Nombre de morts en l'accident                                                                                   |
| NO_PER              | Numèrica      | Nombre de persones implicades en l'accident                                                                     |
| NO_VEHICLE          | Numèrica      | Nombre de vehicles implicats en l'accident                                                                      |

: Variables numèriques vinculades als accidents


```{r, results='asis', echo=FALSE}
a1 <- descr(accident$HOUR, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a1) <- NULL

a2 <- descr(accident$MINUTE, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a2) <- NULL

a3 <- descr(accident$FATALS, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a3) <- NULL

a4 <- descr(accident$DRUNK_DR, transpose = TRUE, stats =  c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", 
                                                        "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a4) <- NULL

a5 <- descr(accident$MORTS, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", 
                                                       "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a5) <- NULL

a6 <- descr(accident$NO_PER, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a6) <- NULL

a7 <- descr(accident$NO_VEHICLE, transpose = TRUE, stats = 
             c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max", "iqr"),
           style = "rmarkdown", justify = "center")
rownames(a7) <- NULL

a <- rbind(a1,a2,a3,a4,a5,a6,a7)
Variable <- c("HOUR", "MINUTE", "FATALS", "DRUNK_DR", "NO_PER", "MORTS", "NO_VEHICLE")
a <- cbind(Variable,a)
kable(a, caption = "Resum de les variables numèriques vinculades als accidents", 
             format = "latex", position = "h!")
```

Per a comprobar que les dades són correctes i que les dades s'han tractat bé en termes de *missings* i *outliers*, farem ús del resum numèric de cada variable que es mostra a la taula superior (taula 13). 

Les variables `HOUR`i `MINUTE` prenen valors entre 0 i 23 i entre 0 i 59 respectivament, els quals són rangs esperats i no donen peu a cap dada atípica en la seva distribució. A la tercera fila de la taula es troba el nombre de ferits a l'accident, `FATALS`, que senyala que no hi ha cap accidents en què no hi hagi, com a mínim, un ferit. També veiem com el nombre màxim que ferits és 5, però en termes generals i en base als quartils 1 i 2 i la mitjana s'observa que la gran majoria dels accidents només presenten una persona ferida. Així mateix, pel que fa al nombre de conductors beguts involucrats a l'accident, `DRUNK_DR`, no involucren a cap conductor begut, és a dir, aquesta variable pren el valor 0 en la majoria dels casos (el 75\% com a mínim, com indica el tercer quartil). Això no obstant, hi ha casos en que hi ha fins a 2 conductors beguts involucrats en un mateix accident. 

-Mirar variables NO_PER i MORTS-

Per últim, en tots els accidents de trànsit hi ha un mínim d'un vehicle, i així ho mostra la variable `NO_VEHICLE`. L'accident amb més vehicles implicats en té 6.

En quant als *missings*, la primera columna de la taula és un recompte dels casos vàlids per a cada variable, és a dir, aquells que no presenten valors mancants per a aquella variable concreta. Es pot comprobar com el mètode de imputació s'ha realitzat correctament, perquè totes les variables presenten el mateix recompte de casos vàlids, que coincideix amb el nombre d'accidents total a la base de dades.

### Variables vinculades a les persones

| Variable            | Tipus         | Descripció                                                                                                      |
|---------------------|---------------|------------------------------------------------------------------------------------------------------------------|
| HOUR                | Numèrica      | Hora de l’accident (99 = desconeguda)                                                                            |
| MINUTE              | Numèrica      | Minut de l’accident                                                                                              |
| FATALS              | Numèrica      | Nombre de ferits a l’accident                                                                                    |
| DRUNK_DR            | Numèrica      | Nombre de conductors beguts involucrats a l’accident                                                              |
| MORTS               | Numèrica      | Nombre de morts en l'accident                                                                                    |
| NO_PER              | Numèrica      | Nombre de persones implicades en l'accident                                                                      |
| NO_VEHICLE          | Numèrica      | Nombre de vehicles implicats en l'accident                                                                       |
| NO_FUGITS           | Numèrica      | Nombre de vehicles fugits implicats en l'accident                                                                |
| AGE                 | Numèrica       | Edat de la persona                                                                                              |

: Variables numèriques vinculades a les persones
       
```{r, results='asis', echo=FALSE}
a1 <- descr(persones$HOUR, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a1) <- NULL

a2 <- descr(persones$MINUTE, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a2) <- NULL

a3 <- descr(persones$FATALS, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a3) <- NULL

a4 <- descr(persones$DRUNK_DR, transpose = TRUE, stats =  c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", 
                                                        "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a4) <- NULL

a5 <- descr(persones$MORTS, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", 
                                                       "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a5) <- NULL

a6 <- descr(persones$NO_PER, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a6) <- NULL

a7 <- descr(persones$NO_VEHICLE, transpose = TRUE, stats = 
             c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max", "iqr"),
           style = "rmarkdown", justify = "center")
rownames(a7) <- NULL

a8 <- descr(persones$NO_FUGITS, transpose = TRUE, stats = c("N.Valid", "min", "q1", 
                                                        "med", "mean", "sd", "q3", 
                                                        "max", "iqr"),
           style = "rmarkdown", justify = "center")
rownames(a8) <- NULL

a9 <- descr(persones$AGE, transpose = TRUE, stats = c("N.Valid", "min", "q1", 
                                                        "med", "mean", "sd", 
                                                        "q3", "max", "iqr"),
           style = "rmarkdown", justify = "center")
rownames(a9) <- NULL

a <- rbind(a1, a2, a3, a4, a5, a6, a7, a8, a9)
variable <- c("HOUR", "MINUTE", "FATALS", "DRUNK_DR", "NO_PER", "MORTS", "NO_VEHICLE", "NO_FUGITS", "EDAT")
a <- cbind(variable,a)
kable(a, caption = "Resum de les variables numèriques vinculades a les persones", 
             format = "latex", position = "h!")
```

En quant a les variables vinculades a les persones, només varien les variables `NO_FUGITS` i `EDAT` respecte a la taula anterior. De fet, la distribució de les variables `HOUR`, `MINUTE`, `FATALS`, `DRUNK_DR`, `NO_PER`, `MORTS` i `NO_VEHICLE` no presenta canvis rellevants respecte a la distribució que es troba a la taula anterior. No es troba cap cas de dada atípica ni cap dada mancant per aquestes variables. Per aquest motiu, ens centrarem ara en els resums de les variables `NO_FUGITS` i `EDAT`.

Pel que fa al nombre de vehicles fugits a l'accident, el tercer quartil indica que al 75\% dels casos no hi ha cap vehicle fugit, i si en fixem en el valor màxim que pren aquesta variable, el cas amb més vehicles fugits en presenta 3. Finalment, en quant a l'edat de les persones, el rang de valors va des de 0 a 98 anys, és a dir, en alguns accidents hi ha implicats nadons, i en d'altres persones de mitjana edat. 

Novament, ens trobem amb que la primera columna de la taula és un recompte dels casos vàlids per a cada variable, és a dir, aquells que no presenten valors mancants per a aquella variable concreta. Es pot comprobar com el mètode de imputació s'ha realitzat correctament, perquè totes les variables presenten el mateix recompte de casos vàlids, que coincideix amb el nombre d'accidents total a la base de dades.

\pagebreak


## Variables categòriques

### Variables vinculades als accidents

**DAY**: Dia de l’accident (de l’1 al 31). Tipus de variable: `r class(persones$DAY)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(accident[,1]) 
```

**RUR_URB**: Informació sobre la localització (1 = Rural, 2 = Urbà, 6 = Via no classificada, 8 = No registrat, 9 = Desconegut). Tipus de variable: `r class(persones$RUR_URB)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(accident[,4]) 
```

**DAY_WEEK**: Dia de la setmana (1 = Diumenge, 2 = Dilluns, . . . , 7 = Dissabte). Tipus de variable: `r class(persones$DAY_WEEK)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(accident[,5]) 
```

**HIHAMORTS**:

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(accident[,11]) 
```

### Variables vinculades a les persones

**SEX**: Sexe de la persona (1 = home, 2 = dona, 8 = No registrat, 9 = Desconegut). Tipus de variable: `r class(persones$SEX)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(persones[,13]) 
```

**PER_TYP**: Tipus de persona (1 = conductor, 2 = ocupant, resta de codis = altres). Tipus de variable: `r class(persones$PER_TYP)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(persones[,14]) 
```

**DOA**: Tipus de víctima (0 = sobreviu, 7 = mort a l’accident, 8 = mort al trasllat, 9 = Desconegut). Tipus de variable: `r class(persones$DOA)` 

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(persones[, 15]) 
```

\pagebreak


# Anàlisi descriptiva bivariant

Per acabar l'anàlisi descriptiva de les dades, s'estudiarà la relació que existeix entre diferents parells de variables. Aquest tipus d'anàlisi ajudarà a esbrinar si existeix una associació entre les variables i, en cas afirmatiu, quina és la força d'aquesta.

Per a la visualització d'aquestes relacions entre variables s'ha fet d'ús d'una plataforma de Google anomenada [Data Studio](https://datastudio.google.com/overview). Aquesta permet convertir les dades en panells o informes complets, fàcils de llegir i de compartir i totalment personalitzables. Algunes de les seves funcionalitats són:

- Descriure les dades amb gràfiques, que inclouen gràfics de línies, de barres i circulars, mapes geogràfics, gràfics d'àrea i de bombolles, taules de dades dinàmiques i molt més.
- Permet que els informes siguin interactius amb filtres de visualització.
- Inclou enllaços i imatges en les quals es pot clicar per crear catàlegs de productes, biblioteques de vídeo i altres continguts amb hipervincles.
- Facilita l'anotació i descripció dels informes amb text i imatges.

A més de presentar totes aquestes característiques, amb Data Studio es poden elaborar fàcilment informes sobre dades procedents d'una gran varietat de fonts, sense necessitat de programar. En tan sols uns instants, permet la connexió a grans conjunts de dades com els que es troben a BigQuery.

### Variables vinculades als accidents

```{r dia-set, echo=FALSE,out.width="49%", out.height="50%",fig.cap="Segons el dia de la setmana", fig.subcap= c("Nombre de conductors beguts", "Quantitat d'accidents"), fig.show='hold',fig.align='center', warning=FALSE, message=FALSE}
knitr::include_graphics(c("~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph1.png","~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph2.png"))
``` 

Pel que fa al nombre de conductors beguts segons el dia de la setmana en el qual succeeix l'accident, s'observa de forma clara a la gràfica esquerra de la figura 5 com la majoria dels conductors beguts es concentren al cap de setmana. Sembla que podria ser un patró perquè hi ha diferències notables entre la quantitat de conductor beguts a finals de la setmana, en comparació als dilluns, dimarts i dimecres. D'altra banda, si ens fixem, en aquest cas, en el nombre de morts segons el dia de la setmana, el dilluns es troba altra vegada en l'última posició, ja que és el dia en què es donen menys morts en accidents de trànsit. Paral·lelament, els últims dies de la setmana presenten un major nombre d'accidents mortals. Aquesta és la informació que presenta la gràfica dreta de la figura 5.

Si es té en compte la informació d'aquestes últimes gràfiques, es podria pensar que existeix una relació entre el nombre de conductors beguts i el nombre de ferits mortals als accidents de trànsit. S'haurà de tenir en compte aquesta hipòtesi per anàlisis posteriors de les dades.

```{r hores, echo=FALSE,out.width="49%", out.height="50%",fig.cap="Nombre de morts en funció del moment del dia", fig.subcap= c("Hores sense agrupar", "Hores agrupades"), fig.show='hold',fig.align='center', warning=FALSE, message=FALSE}
knitr::include_graphics(c("~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph6.png","~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph3_1.png"))
``` 

Si centrem l'atenció en les hores del dia, a la figura 6 es poden veure les freqüències absolutes quant a la quantitat de morts en els diferents moments del dia. A l'esquerra, es divideix el dia en les seves hores, i s'observa com l'hora en què es produeixen més accidents és a les 6 de la tarda. Perquè la gràfica sigui més informativa, s'han agrupat les hores segons els moments del dia per crear la gràfica de la dreta. 

En definitiva, de les dues gràfiques s'extreu que la majoria de les morts es produeixen a la tarda i a la matinada, mentre que el moment del dia on hi ha menys morts és el migdia.


### Variables vinculades a les persones

<center>

![Nombre de morts segons el nombre de conductor beguts a les diferents edats](~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph12.png){width="50%"}

</center> 

Pel que fa a la informació que tenim registrada sobre les persones involucrades en els accidents, i en la línia de les anàlisis anteriors, la figura 7 presenta una gràfica que mostra una clara relació entre el nombre de conductors beguts i el nombre de morts en l'accident a les diferents edats de les persones implicades. Els punts més extrems d'aquesta gràfica (els que presenten major nombre de conductors beguts i, alhora, major nombre de morts) són les edats 22 i 23. Aquestes dades indueixen a pensar que hi ha més perill d'accidents mortals per a la gent jove a la carretera, si hi ha conductors beguts. Una altra manera d'interpretar aquesta gràfica podria ser que hi ha més conductors joves que agafen el cotxe beguts i, en conseqüència, aquest grup d'edat pateix més accidents mortals.

```{r fugits, echo=FALSE,out.width="49%", out.height="50%",fig.cap="Nombre de vehicles fugits", fig.subcap= c("Segons el dia de la setmana", "Segons la setmana del mes"), fig.show='hold',fig.align='center', warning=FALSE, message=FALSE}
knitr::include_graphics(c("~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph8_1.png","~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph11.png"))
``` 

 El nombre de vehicles fugits en els accidents de trànsit varia en funció del moment del dia en que es produeix l'accident, així com en funció de la setmana del mes. A la figura 8 es troba, a l'esquerra, la quantitat de vehicles fugits en els diferents moments del dia, i aquests es concentren sobretot a la tarda (de 15 a 19h incloses) i la matinada (de les 0 a les 5h incloses). En canvi, pel que fa a les diferents setmanes del mes es veu com la majoria de cotxes fugits es troben a la primera i la quarta setmana, i la distribució no és uniforme durant totes les setmanes del mes, com s'esperaria si no hi hagués cap relació entre ambdues variables.

<center>

![Quantitat de supervivents segons el sexe](~/Documents/GitHub/TFG/Data Studio/Gràfics/Table1.png){width="50%"}

</center> 

Pel últim, la figura 9 mostra una taula de contingència entre les variables SEX i DOA (és a dir, el sexe de la persona i el tipus de víctima, si sobreviu o no a l'accident). Aquesta taula marca com a categoria més abundant a la base de dades els homes que sobreviuen a l'accident, i com a menys abundant les dones que no sobreviuen al mateix. 

Si es considera aquesta informació de forma relativa, aproximadament el $39\%$ dels homes implicats en els accidents han siguts ferits mortals, mentre que d'entre les dones ho ha sigut aproximadament el $29\%$. S'hauria d'investigar si aquestes diferències són estadísticament significatives o, d'altra banda, no existeix relació entre el sexe i el tipus de víctima en els accidents de trànsit. 


\pagebreak

# Anàlisi per Components Principals

```{r, include=FALSE}

numeriques <- which(sapply(accident, is.numeric))
dcon <- accident[, numeriques]
sapply(dcon, class)
pc1 <- prcomp(dcon, scale = TRUE)
class(pc1)
attributes(pc1)
```

La nostra base de dades depurada té un total de 7 variables numèriques. Per tant, l'anàlisi de components principals tindrà un total de 7 components. Després de realitzar els càlculs corresponents, obtenim que l'ACP de les variables numèriques és el següent:

```{r, echo=FALSE}
print(pc1)
```
```{r, include=FALSE}
#QUIN PERCENTATGE DE INERCIA ES REPRESENTADA EN EL SUBESPAIS?
#Volem saber quantes dimensions son necesaries per representar fins el 80% de la inercia (variabilitat)
pc1$sdev
(inerProj<- pc1$sdev^2)
(totalIner<- sum(inerProj))
(pinerEix<- 100*inerProj/totalIner)
```

Sabem que cada component representa una inèrcia concreta. Ho podem veure gràficament en els següent gràfic de barres.


```{r, echo=FALSE, out.width="50%", fig.align='center', fig.cap= c("Barplot de la inèrcia de cada component", "Barplot de la inèrcia acumulada")}

#par(mfrow = c(1,2))

fviz_screeplot(pc1, addlabels = TRUE, ylim = c(0, 30), barfill ="#1d91c0", barcolor ="#1d91c0", ggtheme = theme_minimal())

percInerAccum <- 100*cumsum(pc1$sdev[1:dim(dcon)[2]]^2)/dim(dcon)[2]
#percInerAccum
```





Tenint en compte que la inèrcia equival a la proporció de la variabilitat de les dades, sabem que amb un 80% d'inèrcia, podem obtenir gairebé tota la informació. Fent un cop d'ull a la gràfica de la inèrcia, es pot veure que amb les 4 primeres components ja obtenim gairebé el 80% de la inèrcia, així que ens podem servir d'aquestes per al nostre anàlisi.


```{r, include=FALSE}
nd = 4
print(pc1)
attributes(pc1)
pc1$rotation #components principals
```

```{r, include=FALSE}
dim(pc1$x)
dim(dcon)
# Dades als nous eixos de les 5 PCA
Psi = pc1$x[,1:nd]
dim(Psi)
```

```{r, include=FALSE}
iden = row.names(dcon) #Etiquetes dels individus
etiq = names(dcon) #etiquetes de les variables numeriques
ze = rep(0,length(etiq)) # WE WILL NEED THIS VECTOR AFTERWARDS FOR THE GRAPHICS
```



A continuació realitzem un gràfic de dispersió per a totes les combinacions possibles. Diferenciarem els individus, que en el nostre cas són accidents, depenent de si hi ha hagut víctimes mortals o no en aquest. 


```{r, echo=FALSE,  out.width="70%", fig.align='center', fig.cap="Gràfica de la projecció dels individus"}


fviz_pca_ind(pc1, geom.ind = "point", 
             habillage=accident$HIHAMORTS, 
             axes = c(1, 2), 
             pointsize = 1.5) 
```

Es pot observar que les dues primeres components no aconsegueixen diferenciar de forma ambdós grups, i s'esdevenen solapaments. Això no obstant, es veu una lleugera tendència dels accidents sense víctimes mortals a situar-se a valors més elevats de la segona component, i a més baixos de la primera component. 

```{r, include=FALSE}
fviz_pca_var(pc1, col.var = "cos2", 
             geom.var = "arrow", 
             labelsize = 2, 
             repel = FALSE)
```



```{r, include=FALSE}
Phi = cor(dcon, Psi)
#View(Phi)
var <- get_pca_var(pc1)
var
```





## Projecció variables numèriques



En aquest gràfic es pot veure totes les variables numèriques representades en la primera i segona component.



```{r,echo=FALSE, out.width="75%", fig.align='center', fig.cap="Gràfica de la projecció de variables numèriques"}
X <- Phi[, 1]
Y <- Phi[, 2]

#zooms per poder representar-los be
plot(Psi[,1],Psi[,2],type="n",xlim=c(min(X,0),max(X,0)), ylim=c(-1,1), 
     xlab = "CP1: Nombre de persones involucrades", ylab = "CP2: Condicions en què es dona l'accident")
axis(side=1, pos= 0, labels = F)
axis(side=3, pos= 0, labels = F)
axis(side=2, pos= 0, labels = F)
axis(side=4, pos= 0, labels = F)
arrows(ze, ze, X, Y, length = 0.07,col="blue")
text(X,Y,labels=etiq,col="darkblue", cex=0.7)
```

Veiem que la majoria de variables estan representades sobre l’eix horitzontal, que correspon
a la primera component. Aquestes variables són `NO_VEHICLE`, `MORTS`, `FATALS` i `NO_PERSONES`. A més, aquestes dues últimes prenen un valor de gairebé 0.8 i per tant, són les que expliquen amb més precisió la primera component. Ens fixem que totes aquestes variables tenen relació amb el nombre de persones, i per tant, a la primera component li assignarem l’etiqueta de *Nombre de persones involucrades*. Pel que fa a l’eix vertical, només hi ha dues variables que estiguin una mica relacionades amb la segona component. Aquestes són `HOUR` i `DRUNK_DR`. que prenen un valor prop del 0.5. Com que a priori, aquestes dues varaibles no tenen gaire relació l'una amb l'altra, assignarem a la segona component l'etiqueta de *Condicions en què es dona l'accident*, ja que a simple vista cap de les dues destaca sobre l'altre en la seva aportació a la segona component.

\vspace{2mm}

```{r, out.width="50%", fig.cap = "Gràfiques de contribució de les variables a les components principals", fig.subcap= c("Contribució a la PC1", "Contribució a la PC2")}
par(mfrow = c(1,2))
fviz_contrib(pc1, choice = "var", axes = 1, caption=NULL)

fviz_contrib(pc1, choice = "var", axes = 2, caption=NULL)
```

\vspace{2mm}

En aquestes gràfiques, la línia vermella discontinua indica el valor mitjà de contribució. Per una determinada component, una variable amb una contribució major a aquest límit pot considerar-se important a l'hora de contribuir a aquesta component. A l'esquerra, es pot veure que les variables `NO_PER` i `FATALS` són les que més contribueixen a la PC1, tal i com s'havia destacat prèviament. D'altra banda, a la gràfica de la dreta destaca la variable `MORTS` com la més contribuent a la PC2.


Pel que fa als vectors (variables) de la Figura 12, ens podem fixar, també en la seva longitud i en l'angle respecte als eixos de les components principals i entre ells mateixos. 

L'angle que formen les variables `HOU` i `DRUNK_DR` respecte l'eix vertical és petit, la qual cosa ens indica que, tot i no ser les variables més contribuents, estan estretament relacionades amb la creació d'aquesta component. Paral·lelament, es pot dir el mateix de les variables `NO_PER`i `FATALS` respecte a la PC1.

Una altra lectura que se li pot fer als angles entre vectors són les correlacions que mostren entre variables. D'una banda, el nombre de persones i el nombre de vehicles presenten una correlació positiva, ja que presenten un angle prooper a zero entre elles, així com les variables `FATALS` (nombre de ferits) i `MORTS`. D'altra banda, però, també s'entreveu que les variables `MORTS` i `HOUR` estan incorrelacionades, és a dir, són independents l'una de l'altra, perquè presenten un angle de 90$^\circ$, així com les variables `NO_PER` i `NO_VEHICLE` respecte `DRUNK_DR`.

Quant a la longitud, com major sigui la llargària d'un vector relacionat amb una variable (en un rang normalitzat del 0 a l'1), major variabilitat d'aquesta variable està continguda en la representació de les dues components representades, és a dir, millor està representada la seva informació a la gràfica. En aquest cas, `NO_VEHICLE`, `NO_PER`, `FATALS` i `MORTS` són les variables millor representades per les dues primeres components.



```{r, include = FALSE, out.width="70%", fig.align='center'}
biplot(pc1, scale = 0, cex = 0.5, col = c("dodgerblue3", "deeppink3"), xlim = c(-2,14), ylim = c(-5, 6))
```

```{r,include=FALSE}
# Gràfics de projecció de totes les combinacions possibles
par(mfrow=c(1,2), cex.main=0.60, cex.axis=0.65)
for(eje1 in 1:4){
  for(eje2 in (eje1 + 1):5){
    par(cex=1.5)
    plot(Psi[,1],Psi[,2],
         main="Gràfic de dispersió dels individus",
         xlab=paste0("PC",eje1," (",round(pinerEix[eje1],4),"%)"), 
         ylab=paste0("PC",eje2," (",round(pinerEix[eje2],4),"%)"),
         bty="n", col="yellow", pch=".", cex=3)
    #text(Psi[,1],Psi[,2],labels=iden, cex=0.5)
    axis(side=1, pos=0, at=seq(-60, 60, by=2), labels = F,col="red")
    axis(side=3, pos=0, at=seq(-60, 60, by=2), labels = F,col="red")
    axis(side=2, pos=0, at=seq(-60, 60, by=2), labels = F,col="red")
    axis(side=4, pos=0, at=seq(-60, 60, by=2), labels = F,col="red")
    
    }
}
```


## Projecció variables categòriques


```{r,include=FALSE}
#PROJECCIO DE TOTES LES VARIABLES
#anomenem vector de categoriques
(var_categoriques <- which(sapply(accident, is.factor)))
```

També podem fer una projecció de les variables categòriques sobre aquestes components. Si en el mateix gràfic, hi afegim totes les categories de totes les variables categòriques, obtenim el següent:

```{r, echo=FALSE, out.width="70%", fig.align='center', fig.cap="Projecció de les variables categòriques"}
#all qualitative together
plot(Psi[,1], Psi[,2], type = "n", xlim = c(-0.4,0.6), ylim = c(-1, 1), 
     xlab = "CP1: Nombre de persones involucrades", ylab = "CP2: Condicions en què es dona l'accident")

axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")
#nominal qualitative variables
dcat<-c(1:6)
#divide categoricals in several graphs if joint representation saturates
#build a palette with as much colors as qualitative variables 
#colors<-c("blue","red","green","orange","darkgreen")
#alternative
colors <- rainbow(length(var_categoriques))
c <- 1
for(k in var_categoriques){
  seguentColor<-colors[c]
  varcat <- as.factor(accident[,k])
  fdic1 <- tapply(Psi[,1], varcat, mean)
  fdic2 <- tapply(Psi[,2], varcat, mean) 
  text(fdic1, fdic2, levels(varcat), col=seguentColor, cex=1, font=3)
c<-c+1
}
legend("bottomleft",names(var_categoriques)[dcat],pch=1,col=colors, cex=0.6)
```

Clarament aquest gràfic no es pot interpretar, ja que tenim tantes categories que no es poden distingir.
Per tant, el que farem serà crear un gràfic per a cada variable categòrica, a veure si així ens és més fàcil interpretar-los.

```{r, include=FALSE, out.width="70%", fig.align='center', fig.cap="Gràfica de la projecció de variables categòriques"}
col <- rainbow(length(var_categoriques))
c <- 1
for(k in var_categoriques){
  par(cex.main=1, cex.lab=1)
  plot(Psi[,1],Psi[,2],type="n",
    xlab=paste0("PC",eje1," (",round(pinerEix[eje1],4),"%)"),
    ylab=paste0("PC",eje2," (",round(pinerEix[eje2],4),"%)"),
    xlim=c(-2,2), ylim=c(-1,1),
    main="Projeccions sobre el pla factorial de variables categòriques")
  axis(side=1, pos=0, at=seq(-70, 70, by=0.5), labels = F, col="black")
  axis(side=2, pos=0, at=seq(-70, 70, by=0.5), labels = F, col="black")
  axis(side=3, pos=0, at=seq(-70, 70, by=0.5), labels = F, col="black")
  axis(side=4, pos=0, at=seq(-70, 70, by=0.5), labels = F, col="black")
  arrows(ze, ze, X, Y, length = 0.05, col=c("aquamarine3","aquamarine4"))
  text(X,Y,labels=etiq,col=c("aquamarine3","aquamarine4"), cex=1, font=3)
  
  varcat <- as.factor(accident[,k])
  fdic1 <- tapply(Psi[,1], varcat, mean)
  fdic2 <- tapply(Psi[,2], varcat, mean) 
  text(fdic1, fdic2, levels(varcat), col=seguentColor, cex=1, font=3)
  
  legend("bottomleft", legend = names(var_categoriques)[c], fill=seguentColor,
         text.font=2, cex=1, ncol=1, bty="n")
  
  c <- c+1
  
  
}
```

**Variable Dia**

```{r, echo=FALSE, out.width="70%", fig.align='center', fig.cap="Gràfica de la projecció de la variable Dia"}
#scale the projected variables
#X<-fm*U[,1]
#Y<-fm*U[,2]
#represent numerical variables in background
plot(Psi[,1],Psi[,2],type="n",xlim=c(-0.4,0.4), ylim=c(-0.4,0.4), 
     xlab = "CP1: Nombre de persones involucrades", ylab = "CP2: Condicions en què es dona l'accident")
#plot(X,Y,type="none",xlim=c(min(X,0),max(X,0)))
axis(side=1, pos= 0, labels = F, col="lightblue")
axis(side=3, pos= 0, labels = F, col="lightblue")
axis(side=2, pos= 0, labels = F, col="lightblue")
axis(side=4, pos= 0, labels = F, col="lightblue")
#add projections of numerical variables in background
arrows(ze, ze, X, Y, length = 0.07,col="lightgray")
text(X,Y,labels=etiq,col="gray", cex=0.7)
#add ordinal qualitative variables. Ensure ordering is the correct
dordi<-c(1)
#levels(dd[,dordi[1]])
#reorder modalities: when required
accident[,dordi[1]] <- factor(accident[,dordi[1]], ordered=TRUE)
#levels(dd[,dordi[1]])
c<-1
col<-1
for(k in dordi){
  seguentColor<-colors[col]
  fdic1 = tapply(Psi[,1],accident[,k],mean)
  fdic2 = tapply(Psi[,2],accident[,k],mean) 
  
  #points(fdic1,fdic2,pch=16,col=seguentColor, labels=levels(dd[,k]))
  #connect modalities of qualitative variables
  lines(fdic1,fdic2,pch=16,col=seguentColor)
  text(fdic1,fdic2,labels=levels(accident[,k]),col=seguentColor, cex=0.6)
  c<-c+1
  col<-col+1
}
legend("topleft",names(accident)[dordi],pch=1,col=colors[1:length(dordi)], cex=0.6)
```

Amb la variable `Dia` veiem que les categories no formen cap patró rellevant respecte a les components. N'hi ha moltes, cosa que ens dificulta veure quines són les que expliquen millor una component o altra.

\pagebreak

**Variable Localització**

```{r, echo=FALSE, out.width="70%", fig.align='center', fig.cap="Gràfica de la projecció de la variable Localització"}
#scale the projected variables
#X<-fm*U[,eje1]
#Y<-fm*U[,eje2]
#represent numerical variables in background
plot(Psi[,1],Psi[,2],type="n",xlim=c(-0.3,0.3), ylim=c(-0.2,0.2), 
     xlab = "CP1: Nombre de persones involucrades", ylab = "CP2: Condicions en què es dona l'accident")
#plot(X,Y,type="none",xlim=c(min(X,0),max(X,0)))
axis(side=1, pos= 0, labels = F, col="lightblue")
axis(side=3, pos= 0, labels = F, col="lightblue")
axis(side=2, pos= 0, labels = F, col="lightblue")
axis(side=4, pos= 0, labels = F, col="lightblue")
#add projections of numerical variables in background
arrows(ze, ze, X, Y, length = 0.07,col="lightgray")
text(X,Y,labels=etiq,col="gray", cex=0.7)
#add ordinal qualitative variables. Ensure ordering is the correct
dordi<-c(4)
#levels(dd[,dordi[1]])
#reorder modalities: when required
accident[,dordi[1]] <- factor(accident[,dordi[1]], ordered=TRUE)
#levels(dd[,dordi[1]])
c<-1
col<-1
for(k in dordi){
  seguentColor<-colors[col]
  fdic1 = tapply(Psi[,1],accident[,k],mean)
  fdic2 = tapply(Psi[,2],accident[,k],mean) 
  
  #points(fdic1,fdic2,pch=16,col=seguentColor, labels=levels(dd[,k]))
  #connect modalities of qualitative variables
  lines(fdic1,fdic2,pch=16,col=seguentColor)
  text(fdic1,fdic2,labels=levels(accident[,k]),col=seguentColor, cex=0.6)
  c<-c+1
  col<-col+1
}
legend("topleft",names(accident)[dordi],pch=1,col=colors[1:length(dordi)], cex=0.6)
``` 

Per la variable Localització (`RUR_URB`) podem veure clarament que les categories `Urbà` i `Rural` expliquen la segona component, ja que són més properes a aquesta, mentre que la categoria `Desconegut` està més lligada a la primera component.

**Variable Dia de la setmana**

```{r, echo=FALSE, out.width="70%", fig.align='center', fig.cap="Gràfica de la projecció de la variable Dia de la setmana"}
#scale the projected variables
#X<-fm*U[,eje1]
#Y<-fm*U[,eje2]
#represent numerical variables in background
plot(Psi[,1],Psi[,2],type="n",xlim=c(-0.2,0.2), ylim=c(-0.4,0.2), 
     xlab = "CP1: Nombre de persones involucrades", ylab = "CP2: Condicions en què es dona l'accident")
#plot(X,Y,type="none",xlim=c(min(X,0),max(X,0)))
axis(side=1, pos= 0, labels = F, col="lightblue")
axis(side=3, pos= 0, labels = F, col="lightblue")
axis(side=2, pos= 0, labels = F, col="lightblue")
axis(side=4, pos= 0, labels = F, col="lightblue")
#add projections of numerical variables in background
arrows(ze, ze, X, Y, length = 0.07,col="lightgray")
text(X,Y,labels=etiq,col="gray", cex=0.7)
#add ordinal qualitative variables. Ensure ordering is the correct
dordi<-c(5)
#levels(dd[,dordi[1]])
#reorder modalities: when required
accident[,dordi[1]] <- factor(accident[,dordi[1]], ordered=TRUE)
#levels(dd[,dordi[1]])
c<-1
col<-1
for(k in dordi){
  seguentColor<-colors[col]
  fdic1 = tapply(Psi[,1],accident[,k],mean)
  fdic2 = tapply(Psi[,2],accident[,k],mean) 
  
  #points(fdic1,fdic2,pch=16,col=seguentColor, labels=levels(dd[,k]))
  #connect modalities of qualitative variables
  lines(fdic1,fdic2,pch=16,col=seguentColor)
  text(fdic1,fdic2,labels=levels(accident[,k]),col=seguentColor, cex=0.6)
  c<-c+1
  col<-col+1
}
legend("topleft",names(accident)[dordi],pch=1,col=colors[1:length(dordi)], cex=0.6)
```

Per la variable Dia de la setmana (`DAY_WEEK`) ens trobem amb que les categories que estan millor representades per les primeres components són divendres, dissabte i diumenge, ja que presenten els vectors amb major longitud. D'entre aquestes, divendres sembla més lligada a la primera component, mentre que dissabte i diumenge contribueixen de forma semblant a ambdues components.

\pagebreak

**Variable HIHAMORTS**

```{r, echo=FALSE, out.width="70%", fig.align='center', fig.cap="Gràfica de la projecció de la variable HIHAMORTS"}
#scale the projected variables
#X<-fm*U[,eje1]
#Y<-fm*U[,eje2]
#represent numerical variables in background
plot(Psi[,1],Psi[,2],type="n",xlim=c(-0.7,0.5), ylim=c(-0.5,0.8), 
     xlab = "CP1: Nombre de persones involucrades", ylab = "CP2: Condicions en què es dona l'accident")
#plot(X,Y,type="none",xlim=c(min(X,0),max(X,0)))
axis(side=1, pos= 0, labels = F, col="lightblue")
axis(side=3, pos= 0, labels = F, col="lightblue")
axis(side=2, pos= 0, labels = F, col="lightblue")
axis(side=4, pos= 0, labels = F, col="lightblue")
#add projections of numerical variables in background
arrows(ze, ze, X, Y, length = 0.07,col="lightgray")
text(X,Y,labels=etiq,col="gray", cex=0.7)
#add ordinal qualitative variables. Ensure ordering is the correct
dordi<-c(11)
#levels(dd[,dordi[1]])
#reorder modalities: when required
accident[,dordi[1]] <- factor(accident[,dordi[1]], ordered=TRUE)
#levels(dd[,dordi[1]])
c<-1
col<-1
for(k in dordi){
  seguentColor<-colors[col]
  fdic1 = tapply(Psi[,1],accident[,k],mean)
  fdic2 = tapply(Psi[,2],accident[,k],mean) 
  
  #points(fdic1,fdic2,pch=16,col=seguentColor, labels=levels(dd[,k]))
  #connect modalities of qualitative variables
  lines(fdic1,fdic2,pch=16,col=seguentColor)
  text(fdic1,fdic2,labels=levels(accident[,k]),col=seguentColor, cex=0.6)
  c<-c+1
  col<-col+1
}
legend("topleft",names(accident)[dordi],pch=1,col=colors[1:length(dordi)], cex=0.6)
```

Per la variable `HIHAMORTS` tenim dues categories que presenten una correlació negativa total, és a dir, si no pertany a una categoria, pertany a l'altra, evidentment. D'entre aquestes, la categoria **NO** queda més explicada per les primeres components, i ambdues categories contribueixen de forma igualitaria en les dues components, ja que presenten aproximadament 45$^{\circ}$.


**Variable Hora grupada**

```{r, echo=FALSE, out.width="70%", fig.align='center', fig.cap="Gràfica de la projecció de la variable Hora agrupada"}
#scale the projected variables
#X<-fm*U[,eje1]
#Y<-fm*U[,eje2]
#represent numerical variables in background
plot(Psi[,1],Psi[,2],type="n",xlim=c(-0.3,0.3), ylim=c(-1,1), 
     xlab = "CP1: Nombre de persones involucrades", ylab = "CP2: Condicions en què es dona l'accident")
#plot(X,Y,type="none",xlim=c(min(X,0),max(X,0)))
axis(side=1, pos= 0, labels = F, col="lightblue")
axis(side=3, pos= 0, labels = F, col="lightblue")
axis(side=2, pos= 0, labels = F, col="lightblue")
axis(side=4, pos= 0, labels = F, col="lightblue")
#add projections of numerical variables in background
arrows(ze, ze, X, Y, length = 0.07,col="lightgray")
text(X,Y,labels=etiq,col="gray", cex=0.7)
#add ordinal qualitative variables. Ensure ordering is the correct
dordi<-c(12)
#levels(dd[,dordi[1]])
#reorder modalities: when required
accident[,dordi[1]] <- factor(accident[,dordi[1]], ordered=TRUE)
#levels(dd[,dordi[1]])
c<-1
col<-1
for(k in dordi){
  seguentColor<-colors[col]
  fdic1 = tapply(Psi[,1],accident[,k],mean)
  fdic2 = tapply(Psi[,2],accident[,k],mean) 
  
  #points(fdic1,fdic2,pch=16,col=seguentColor, labels=levels(dd[,k]))
  #connect modalities of qualitative variables
  lines(fdic1,fdic2,pch=16,col=seguentColor)
  text(fdic1,fdic2,labels=levels(accident[,k]),col=seguentColor, cex=0.6)
  c<-c+1
  col<-col+1
}
legend("topleft",names(accident)[dordi],pch=1,col=colors[1:length(dordi)], cex=0.6)
```

Per la variable hora agrupada (`HOUR_agrupat`) tenim cinc categories. D'entre aquestes, els accidents que queden millor explicats per les primeres components són els que es donen a la matinada. Sembla que les categories **migdia** i **nit** estan més lligades a la primera component, mentre que **matinada** ho està a la segona. A més, la categoria que queda menys explicada és el **matí**.

\pagebreak

**Variable Setmana**

```{r, echo=FALSE, out.width="70%", fig.align='center', fig.cap="Gràfica de la projecció de la variable Setmana"}
#scale the projected variables
#X<-fm*U[,eje1]
#Y<-fm*U[,eje2]
#represent numerical variables in background
plot(Psi[,1],Psi[,2],type="n",xlim=c(-1,1), ylim=c(-0.2,0.2), 
     xlab = "CP1: Nombre de persones involucrades", ylab = "CP2: Condicions en què es dona l'accident")
#plot(X,Y,type="none",xlim=c(min(X,0),max(X,0)))
axis(side=1, pos= 0, labels = F, col="lightblue")
axis(side=3, pos= 0, labels = F, col="lightblue")
axis(side=2, pos= 0, labels = F, col="lightblue")
axis(side=4, pos= 0, labels = F, col="lightblue")
#add projections of numerical variables in background
arrows(ze, ze, X, Y, length = 0.07,col="lightgray")
text(X,Y,labels=etiq,col="gray", cex=0.7)
#add ordinal qualitative variables. Ensure ordering is the correct
dordi<-c(13)
#levels(dd[,dordi[1]])
#reorder modalities: when required
accident[,dordi[1]] <- factor(accident[,dordi[1]], ordered=TRUE)
#levels(dd[,dordi[1]])
c<-1
col<-1
for(k in dordi){
  seguentColor<-colors[col]
  fdic1 = tapply(Psi[,1],accident[,k],mean)
  fdic2 = tapply(Psi[,2],accident[,k],mean) 
  
  #points(fdic1,fdic2,pch=16,col=seguentColor, labels=levels(dd[,k]))
  #connect modalities of qualitative variables
  lines(fdic1,fdic2,pch=16,col=seguentColor)
  text(fdic1,fdic2,labels=levels(accident[,k]),col=seguentColor, cex=0.6)
  c<-c+1
  col<-col+1
}
legend("topleft",names(accident)[dordi],pch=1,col=colors[1:length(dordi)], cex=0.6)
```

Per la variable `Setmana` s'aprecia que cap de les categories està gaire explicada per les primeres components, ja que els vectors són de molt poca longitud, i tampoc s'entreveu cap patró destacable.



