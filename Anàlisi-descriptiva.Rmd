---
title: "Anàlisi descriptiva"
author: "Anna Salazar"
date: "`r Sys.Date()`"
output: pdf_document
header-includes:
 - \pagenumbering{gobble}
 - \usepackage{subfig}
 - \usepackage[labelsep=period]{caption}
 - \usepackage[labelfont=bf]{caption}
 - \usepackage{floatrow}
editor_options:
  markdown:
    wrap: 72
---
\vspace{130mm}

<left>
![](~/Documents/GitHub/TFG/Imatges portada/fme.png){width="50%"}
</left> <right>
![](~/Documents/GitHub/TFG/Imatges portada/UB.png){width="50%"}
</right> 
\newpage

\renewcommand{\contentsname}{Índex}
\renewcommand{\figurename}{Figura}
\renewcommand{\tablename}{Taula}
\floatsetup[table]{capposition=bottom}
\floatsetup[figure]{capposition=bottom}
\captionsetup{width=.75\textwidth}
\tableofcontents

\pagebreak

\pagenumbering{arabic}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#install.packages("bigrquery")
library(bigrquery)
library(kableExtra)
library(DBI)
library(knitr)
library(dplyr)
library(VIM)
library(tidyverse)
library(summarytools)
library(reshape2)
library(ggplot2)
library(devtools)
library(naniar)
library(knitr)
library(forcats)

projecte <- "level-oxygen-353005"

dades <- dbConnect(
  bigrquery::bigquery(),
  project = projecte,
  dataset = "examen_final",
  billing = projecte
)
```


# Descripció de la base de dades

```{r, warning=FALSE, message=FALSE}
bd <- data.frame(dbGetQuery(dades, 
          "SELECT * FROM `level-oxygen-353005.examen_final.person` AS B
 LEFT JOIN (SELECT T.*, HIT_RUN, TRAV_SP, PREV_SP
            FROM (SELECT A.*, COUNT(C.ST_CASE) AS NO_VEHICLES
                  FROM (SELECT `level-oxygen-353005.examen_final.accident`.*, 
                  COUNT(B1.ST_CASE) AS NO_PER
                        FROM `level-oxygen-353005.examen_final.accident` 
                              INNER JOIN 
                              `level-oxygen-353005.examen_final.person` AS B1
                        ON `level-oxygen-353005.examen_final.accident`.ST_CASE = B1.ST_CASE
                        GROUP BY `level-oxygen-353005.examen_final.accident`.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK, FATALS, DRUNK_DR) AS A 
                      INNER JOIN `level-oxygen-353005.examen_final.vehicle` AS C
                      ON A.ST_CASE = C.ST_CASE
                      GROUP BY A.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK, FATALS, DRUNK_DR, NO_PER) AS T INNER JOIN `level-oxygen-353005.examen_final.vehicle` AS C2
                      ON T.ST_CASE = C2.ST_CASE) AS T2
          ON B.ST_CASE = T2.ST_CASE"))

bd <- bd[,-c(1, 2, 7)]
n <- nrow(bd)

bd <- data.frame(bd)
for(i in c(2, 3, 4, 5, 8, 9, 14, 16)) {
  bd[,i]<-as.factor(bd[,i])
}
```

La base de dades que serà utilitzada al llarg de l'estudi prové d'una companyia d'assegurances per a vehicles i conté un llistat d’accidents de tràfic ocorreguts al desembre de 2015 als Estats Units, juntament amb un recompte de totes les persones (conductors, passatgers o vianants) involucrades als accidents i, finalment, un inventari de tots els vehicles involucrats als accidents.


Més concretament, a la base de dades es poden trobar les variables següents:

| Variable           | Tipus         | Descripció                                                                                                        |
|--------------------|---------------|-------------------------------------------------------------------------------------------------------------------|
| DAY                | Categòrica    | Dia de l’accident (de l’1 al 31)                                                                                  |
| HOUR               | Numèrica      | Hora de l’accident (99 = desconeguda)                                                                             |
| MINUTE             | Numèrica      | Minut de l’accident (99 = desconegut)                                                                             |
| RUR_URB            | Categòrica    | Informació sobre la localització (1 = Rural, 2 = Urbà, 6 = Via no classificada, 8 = No registrat, 9 = Desconegut) |
| DAY_WEEK           | Categòrica    | Dia de la setmana (1 = Diumenge, 2 = Dilluns, ..., 7 = Dissabte)                                                  |
| FATALS             | Numèrica      | Nombre de ferits a l’accident                                                                                     |
| DRUNK_DR           | Numèrica      | Nombre de conductors beguts involucrats a l’accident                                                              |
| NO_PER             | Numèrica      | Nombre de persones implicades en l'accident                                                                      |
| AGE                | Numèrica      | Edat de la persona (998 = No registrada, 999 = Desconeguda)                                                       |
| SEX                | Categòrica    | Sexe de la persona (1 = home, 2 = dona, 8 = No registrat, 9 = Desconegut)                                         |
| PER_TYP            | Categòrica    | Tipus de persona (1 = conductor, 2 = ocupant, resta de codis = altres)                                            |
| DOA                | Categòrica    | Tipus de víctima (0 = sobreviu, 7 = mort a l’accident, 8 = mort al trasllat, 9 = Desconegut)                      |
| NO_VEH             | Numèrica      | Nombre de vehicles implicats en l'accident                                                                        |
| HIT_RUN            | Categòrica    | Identificador de vehicle fugit (0 = No, 1 = Sí, 9 = Desconegut)                                                   |
| TRAV_SP            | Numèrica      | Velocitat estimada (mph)[^1] del vehicle quan va tenir l’accident (997,998 i 999 = Desconegut)                    |
| PREV_SP            | Categòrica    | Indicador d’existència de límit de velocitat permesa just abans de l’accident (997,998 i 999 = Desconegut)        |

: Llistat de variables de la base de dades

[^1]: mph vol dir milles per hora. 100 mph = 161 Km/h



## Objectius del projecte

Estudiant aquesta base de dades sobre persones que s'han vist implicades, de forma directa o indirecta, en accidents de trànsit es preten:

- Representar les dades de manera nítida

- Analitzar els diferents perfils de persones que pateixen accidents de trànsit

- Desenvolupar un model de predicció que ens permeti establir el tipus de víctima que serà cada persona depenent les característiques de l'accident i els vehicles. 

- Estudiar les relacions de dependència entre variables

\pagebreak

# Preprocessament

La base de dades d'aquest projecte està formada per `r ncol(bd)` variables (columnes) i `r n` individus (files).

Les variables que tenim són AGE, SEX, PER_TYP, DOA, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK, FATALS, DRUNK_DR, NO_PER, NO_VEHICLES, HIT_RUN, TRAV_SP i PREV_SP.


## Missings

Per a poder tractar les dades mancants de la base de dades, en primer lloc haurem de tranformar-les, ja que les variables que presenten dades mancants les tenen codificades.

En el cas de les variables numèriques amb *missings*, que són l'edat (AGE), l'hora (HOUR), el minut (MINUTE) i la velocitat estimada del vehicle quan va tenir l'accident (TRAV_SP), les codificacions per aquestes dades són 99, 997, 998 o 999, depenent de cada cas.

```{r}
bd <- bd %>% replace_with_na(replace = list(TRAV_SP = c(997, 998, 999)))
bd$TRAV_SP <- bd$TRAV_SP*1.61
bd <- bd %>% replace_with_na(replace = list(AGE = c(998, 999)))
bd <- bd %>% replace_with_na(replace = list(MINUTE = c(99)))
bd <- bd %>% replace_with_na(replace = list(HOUR = c(99)))
```

Un cop transformades aquestes dades, podem visualitzar a la taula següent els *missings* per cada variable numèrica, tant en terme absolut com relatiu.

```{r, out.width = "50%", results='asis'}
propmiss <- function(dataframe) lapply(dataframe,function(x) data.frame(na = sum(is.na(x)),
                    n = length(x),  propNA = round(sum(is.na(x))/length(x),4) * 100))
missings <- propmiss(bd[,c(1, 6, 7, 10, 11, 12, 13, 15)])
missings <- do.call(rbind.data.frame, missings)
kable(missings[,-2], caption = "Percentatge de missings per variable", col.names = c("NA","Percentatge de NA"), format="latex", position = "h!") 
```

## Outliers

*Per fer*

## Variable resposta

```{r echo=FALSE}
descriptiva <- function(X, nom,dades){
  if (!(is.numeric(X) || class(X) == "Date")){ 
    frecs <- table(as.factor(X), useNA = "no"); proportions <- frecs/n
    dataf <- data.frame(x = levels(as.factor(X)), y = frecs)
    par(mfrow=c(1,2))
    print(ggplot(dataf, aes(x = "", y = frecs, fill = x)) + 
            geom_bar(stat = "identity", width = 1) + 
            scale_y_continuous(expand = c(0,0)) + coord_polar("y", start = 0) +
            scale_fill_brewer(palette = "YlGnBu") +
            theme_minimal())
    print(ggplot(dataf, aes(x = x, y=frecs)) + geom_bar(stat = "identity", 
          color = "#1d91c0", fill = "#1d91c0") + 
            scale_y_continuous(expand = c(0,0)) + theme_void())
    x <- data.frame(X)
    colnames(x) <- nom
    st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = FALSE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
    dfSummary(x) 

   }else{
      par(mfrow=c(1,2))
      print(ggplot(dades, aes(x = X)) + geom_bar(col = "#1d91c0", fill = 
      "#1d91c0") + theme_minimal())
      print(ggplot(dades, aes(y = X)) + geom_boxplot(col = "#1d91c0", outlier.colour="red", outlier.shape=8,
       outlier.size=4) + theme_minimal())
       a <- descr(X, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", 
                 "mean", "sd", "q3", "max", "iqr"), style = "rmarkdown", justify 
                 = "center")
       rownames(a) <- NULL
       kable(a, caption = paste("Resum numèric de la variable", nom), 
             format = "latex", position = "h!")
   }
}
```

Ja que un dels objectius del treball és el desenvolupament d'un model de predicció que ens permeti establir el tipus de víctima que serà cada persona, depenent les característiques de l'accident i els vehicles, la variable depenent o resposta del treball és `DOA`. 

A continuació es pot veure un breu anàlisi descriptiu de la variable:

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Tipus de víctima", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(bd[,4], "Tipus de víctima", dades = bd)
```

No hi ha cap dada mancant en aquesta variable, encara que hi ha $3$ persones de que quals el seu estat després de l'accident és desconegut. 

## Categoritzar

En el cas de les dades mancants que es troben en variables categòriques, el que es farà serà factoritzar-les i, seguidament, definir els nivells que presenta el factor. Així, per exemple, la variable **PER_TYP** presenta $8$ nivells que s'han d'agrupar en $3$ (*Conductor*, *Ocupant* i *Altres*). 

A continuació es mostren els canvis realitzats a algunes de les variables categòriques de la base de dades:

**PER_TYP**: Tipus de persona (1 = conductor, 2 = ocupant, resta de codis = altres).

Abans

```{r}
levels(bd$PER_TYP)
```

Després

```{r}
levels(bd$PER_TYP) <- c("Conductor", "Ocupant", "Altres", "Altres", "Altres", 
                        "Altres", "Altres", "Altres")
levels(bd$PER_TYP)
```

**HIT_RUN**: Identificador de vehicle fugit (0 = No, 1 = Sí, 9 = Desconegut).

Abans

```{r}
levels(bd$HIT_RUN)
```

Després

```{r}
levels(bd$HIT_RUN) <- c("No", "Sí", "Desconegut")
levels(bd$HIT_RUN)
```

**PREV_SP**: Indicador d’existència de límit de velocitat permesa just abans de l’accident (997,998 i 999 = Desconegut).

Abans

```{r}
levels(bd$PREV_SP)
```

Després

```{r}
levels(bd$PREV_SP) <- c("0", "1", "2", "3", "4", "5", "7", "9", "Desconegut", 
                        "Desconegut")
levels(bd$PREV_SP)
```

**DAY_WEEK**: Dia de la setmana (1 = Diumenge, 2 = Dilluns, . . . , 7 = Dissabte).

Abans

```{r}
levels(bd$DAY_WEEK)
```

Després

```{r}
levels(bd$DAY_WEEK) <- c("Diumenge", "Dilluns", "Dimarts", "Dimecres", "Dijous",
                         "Divendres", "Dissabte")
levels(bd$DAY_WEEK)
```

**SEX**: Sexe de la persona (1 = home, 2 = dona, 8 = No registrat, 9 = Desconegut).

Abans

```{r}
levels(bd$SEX)
```

Després

```{r}
levels(bd$SEX) <- c("Home", "Dona", "No registrat", "Desconegut")
levels(bd$SEX)
```

**RUR_URB**: Informació sobre la localització (1 = Rural, 2 = Urbà, 6 = Via no classificada, 8 = No registrat, 9 = Desconegut). 

Abans

```{r}
levels(bd$RUR_URB)
```

Després

```{r}
levels(bd$RUR_URB) <- c("Rural", "Urbà", "Via no classificada", 
                        "No registrat", "Desconegut")
levels(bd$RUR_URB)
```

```{r}
lev <- c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", 
         "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25",
         "26", "27", "28", "29", "30", "31")
bd$DAY <- factor(bd$DAY, levels = lev)
```

\pagebreak

# Anàlisi univariant

## Variables numèriques

**HOUR**: Hora de l’accident (99 = desconeguda).  Tipus de variable: `r class(bd$HOUR)`

**MINUTE**: Minut de l’accident (99 = desconegut). Tipus de variable: `r class(bd$MINUTE)`

**FATALS**: Nombre de ferits a l’accident. Tipus de variable: `r class(bd$FATALS)`

**DRUNK_DR**: Nombre de conductors beguts involucrats a l’accident. Tipus de variable: `r class(bd$DRUNK_DR)`

**NO_PER**: Nombre de persones implicades en l’accident. Tipus de variable: `r class(bd$NO_PER)`

**AGE**: Edat de la persona (998 = No registrada, 999 = Desconeguda). Tipus de variable: `r class(bd$AGE)`

**NO_VEH**: Nombre de vehicles implicats en l’accident. Tipus de variable: `r class(bd$NO_VEH)`

**TRAV_SP**: Velocitat estimada (km) del vehicle quan va tenir l’accident (997,998 i 999 = Desconegut). Tipus de variable: `r class(bd$TRAV_SP)`

```{r, results='asis', echo=FALSE}
a <- descr(bd[, c(1, 6, 7, 10, 11, 12, 13, 15)], transpose = TRUE, stats = 
             c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max", "iqr"),
           style = "rmarkdown", justify = "center")
rownames(a) <- NULL
kable(a, caption = "Resum de les variables numèriques", 
             format = "latex", position = "h!")
```


## Variables categòriques

**DAY**: Dia de l’accident (de l’1 al 31). Tipus de variable: `r class(bd$DAY)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(bd[, 5]) 
```

**RUR_URB**: Informació sobre la localització (1 = Rural, 2 = Urbà, 6 = Via no classificada, 8 = No registrat, 9 = Desconegut). Tipus de variable: `r class(bd$RUR_URB)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(bd[,8]) 
```

**DAY_WEEK**: Dia de la setmana (1 = Diumenge, 2 = Dilluns, . . . , 7 = Dissabte). Tipus de variable: `r class(bd$DAY_WEEK)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(bd[,9]) 
```

**SEX**: Sexe de la persona (1 = home, 2 = dona, 8 = No registrat, 9 = Desconegut). Tipus de variable: `r class(bd$SEX)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(bd[,2]) 
```

**PER_TYP**: Tipus de persona (1 = conductor, 2 = ocupant, resta de codis = altres). Tipus de variable: `r class(bd$PER_TYP)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(bd[,3]) 
```

**DOA**: Tipus de víctima (0 = sobreviu, 7 = mort a l’accident, 8 = mort al trasllat, 9 = Desconegut). Tipus de variable: `r class(bd$DOA)` 

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(bd[, 4]) 
```

**HIT_RUN**: Identificador de vehicle fugit (0 = No, 1 = Sí, 9 = Desconegut). Tipus de variable: `r class(bd$HIT_RUN)` 

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(bd[,14]) 
```

**PREV_SP**: Indicador d’existència de límit de velocitat permesa just abans de l’accident (997,998 i 999 = Desconegut). Tipus de variable: `r class(bd$PREV_SP)` 

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(bd[,16]) 
```

