---
title: "Anàlisi descriptiva"
author: "Anna Salazar"
date: "`r Sys.Date()`"
output: pdf_document
header-includes:
 - \pagenumbering{gobble}
 - \usepackage{subfig}
 - \usepackage[labelsep=period]{caption}
 - \usepackage[labelfont=bf]{caption}
 - \usepackage{floatrow}
editor_options:
  markdown:
    wrap: 72
---
\vspace{130mm}

<left>
![](~/Documents/GitHub/TFG/Imatges portada/fme.png){width="50%"}
</left> <right>
![](~/Documents/GitHub/TFG/Imatges portada/UB.png){width="50%"}
</right> 
\newpage

\renewcommand{\contentsname}{Índex}
\renewcommand{\figurename}{Figura}
\renewcommand{\tablename}{Taula}
\floatsetup[table]{capposition=bottom}
\floatsetup[figure]{capposition=bottom}
\captionsetup{width=.75\textwidth}
\tableofcontents

\pagebreak

\pagenumbering{arabic}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#install.packages("bigrquery")
library(bigrquery)
library(kableExtra)
library(DBI)
library(knitr)
library(dplyr)
library(VIM)
library(tidyverse)
library(summarytools)
library(reshape2)
library(ggplot2)
library(devtools)
library(naniar)
library(knitr)
library(forcats)
library(sqldf)

projecte <- "level-oxygen-353005"

dades <- dbConnect(
  bigrquery::bigquery(),
  project = projecte,
  dataset = "examen_final",
  billing = projecte
)
```


# Descripció de la base de dades

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
A <- data.frame(dbGetQuery(dades, "SELECT * FROM `level-oxygen-353005.examen_final.accident`"))
B <- data.frame(dbGetQuery(dades, "SELECT * FROM `level-oxygen-353005.examen_final.person`"))
C <- data.frame(dbGetQuery(dades, "SELECT * FROM `level-oxygen-353005.examen_final.vehicle`"))
C$HIT_RUN[C$HIT_RUN==9] <- 0 
B$MORT == 0
B$MORT[B$DOA==7 | B$DOA==8 ] <- 1 
```

Les bases de dades que seran utilitzades al llarg de l'estudi provenen de l'agència estatal de trànsit dels Estats Units i contenen tres taules, entre les quals s'hi troba un llistat d’accidents de tràfic ocorreguts al desembre de 2015 als Estats Units, juntament amb un recompte de totes les persones (conductors, passatgers o vianants) involucrades als accidents i, finalment, un inventari de tots els vehicles involucrats als accidents. 

L'enllaç a la base esmentada és el següent: 

<https://www.transportation.gov/briefing-room/traffic-fatalities-sharply-2015>


Més concretament, en cada taula es poden trobar les variables següents:

**Accident** és un llistat d’accidents de trànsit ocorreguts al desembre de 2015 als Estats Units.

| Variable           | Tipus         | Descripció                                                                                                        |
|--------------------|---------------|-------------------------------------------------------------------------------------------------------------------|
| ST_CASE            | Categòrica    | Codi de l’accident                                                                                                |
| DAY                | Categòrica    | Dia de l’accident (de l’1 al 31)                                                                                  |
| HOUR               | Numèrica      | Hora de l’accident (99 = desconeguda)                                                                             |
| MINUTE             | Numèrica      | Minut de l’accident (99 = desconegut)                                                                             |
| RUR_URB            | Categòrica    | Informació sobre la localització (1 = Rural, 2 = Urbà, 6 = Via no classificada, 8 = No registrat, 9 = Desconegut) |
| DAY_WEEK           | Categòrica    | Dia de la setmana (1 = Diumenge, 2 = Dilluns, ..., 7 = Dissabte)                                                  |
| FATALS             | Numèrica      | Nombre de ferits a l’accident                                                                                     |
| DRUNK_DR           | Numèrica      | Nombre de conductors beguts involucrats a l’accident                                                              |
: Llistat de variables de la taula Accident

**Person** és un llistat de totes les persones (conductors, passatgers o vianants) involucrades als accidents.

| Variable           | Tipus         | Descripció                                                                                                        |
|--------------------|---------------|-------------------------------------------------------------------------------------------------------------------|
| ST_CASE            | Categòrica    | Codi de l’accident al qual està involucrada la persona                                                            |
| PER_NO             | Categòrica    | Nombre de la persona dins de cada accident                                                                        |
| AGE                | Numèrica      | Edat de la persona (998 = No registrada, 999 = Desconeguda)                                                       |
| SEX                | Categòrica    | Sexe de la persona (1 = home, 2 = dona, 8 = No registrat, 9 = Desconegut)                                          |
| PER_TYP            | Categòrica    | Tipus de persona (1 = conductor, 2 = ocupant, resta de codis = altres)                                            |
| DOA                | Categòrica    | Tipus de víctima (0 = sobreviu, 7 = mort a l’accident, 8 = mort al trasllat, 9 = Desconegut)                |

: Llistat de variables de la taula Person

**Vehicle** és un llistat de tots els vehicles involucrats als accidents.


| Variable           | Tipus         | Descripció                                                                                                        |
|--------------------|---------------|-------------------------------------------------------------------------------------------------------------------|
| ST_CASE            | Categòrica    | Codi de l’accident al qual està involucrat el vehicle                                                             |
| NO_VEH             | Numèrica      | Nombre de vehicles implicats en l'accident                                                                        |
| HIT_RUN            | Categòrica    | Identificador de vehicle fugit (0 = No, 1 = Sí, 9 = Desconegut)                                                   |
| TRAV_SP            | Numèrica      | Velocitat estimada (mph) del vehicle quan va tenir l’accident (997,998 i 999 = Desconegut)                        |
| PREV_SP            | Categòrica    | Indicador d’existència de límit de velocitat permesa just abans de l’accident (997,998 i 999 = Desconegut)  |

: Llistat de variables de la taula Vehicle




## Objectius del projecte

Estudiant aquesta base de dades sobre persones que s'han vist implicades, de forma directa o indirecta, en accidents de trànsit es preten:

- Descriure els tipus d'accidents que estan registrats

- Analitzar els diferents perfils de persones que pateixen accidents de trànsit

- Desenvolupar un model de predicció que ens permeti establir el tipus de víctima que serà cada persona depenent les característiques de l'accident i els vehicles. 

- Estudiar les relacions de dependència entre variables

\pagebreak

# Lectura de les dades

A partir d'aquestes tres taules, s'extreuran dues bases de dades a partir de les quals es treballarà al llarg del projecte.

En primer lloc, es tindrà en compte la informació dels accidents. D'aquesta manera es podrà estudiar les característiques dels diferents accidents regitrats, així com es podran fer prediccions sobre els nous accidents en funció de les seves característiques. S'ha anomenat aquesta base `accident`, i està conformada per les variables següents: DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK, FATALS, DRUNK_DR, NO_PER, MORTS, NO_VEHICLE, HIHAMORTS.

Les variables **MORTS**, **NO_PER**, **NO_VEHICLE** i **HIHAMORTS** han sigut creades a posteriori a partir de les taules de les que es disposava, i es defineixen a continuació:

| Variable            | Tipus         | Descripció                                                                                                      |
|---------------------|---------------|------------------------------------------------------------------------------------------------------------------|
| MORTS               | Numèrica      | Nombre de morts en l'accident                                                                                   |
| NO_PER              | Numèrica      | Nombre de persones implicades en l'accident                                                                     |
| NO_VEHICLE          | Numèrica      | Nombre de vehicles implicats en l'accident                                                                      |
| HIHAMORTS           | Categòrica    | Variable identificadora dels accidents mortals (0: no hi ha morts en l'accident, 1: hi ha morts en l'accident)|

: Llistat de variables definides a posteriori per a la taula Accidents

```{r}
# Nombre de persones per accident
query11 <- sqldf("SELECT DISTINCT A.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK,
                                 FATALS, DRUNK_DR, COUNT(B.ST_CASE) AS NO_PER, SUM(MORT) AS MORTS
                        FROM B INNER JOIN  A 
                        ON A.ST_CASE = B.ST_CASE
                        GROUP BY A.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK,
                                 FATALS, DRUNK_DR")

query11$MORTS[is.na(query11$MORTS)] <- 0

# Nombre de vehicles per accident
query12 <- sqldf("SELECT DISTINCT A.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK,
                                 FATALS, DRUNK_DR, COUNT(C.ST_CASE) AS NO_VEHICLE
                        FROM C INNER JOIN  A 
                        ON A.ST_CASE = C.ST_CASE
                        GROUP BY A.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK,
                                 FATALS, DRUNK_DR")


# Ajuntem l'accident amb el nombre de persones i el nombre de vehicles
accidents <- sqldf("SELECT query11.*, NO_VEHICLE
                        FROM query11 INNER JOIN  query12 
                        ON query11.ST_CASE = query12.ST_CASE")
accident <- accidents[,-1]

accident$HIHAMORTS = 0
accident$HIHAMORTS[accidents$MORTS>0] <- 1

accident <- data.frame(accident)
for(i in c(1, 4, 5, 11)) {
  accident[,i]<-as.factor(accident[,i])
}
```


D'altra banda, s'estudiarà la informació sobre les persones implicades en aquests accidents. D'aquesta manera es podrà perfilar el tipus de conductors en els casos en que hi hagi morts en l'accident, així com en els que no hi hagi. Aquesta informació també ens facilitarà l'elaboració de possibles models per predir el tipus de víctima que serà una persona involucrada en un accident de trànsit en base a les seves característiques. en aquest cas, s'ha anomenat aquesta base `persones`, i està conformada per les variables següents: DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK, FATALS, DRUNK_DR, NO_PER, MORTS, NO_VEHICLE, NO_FUGITS, AGE, SEX, PERTYP i DOA.

Las variable **NO_FUGITS** ha sigut creada a posteriori a partir de les taules de les que es disposava, i es defineix a continuació:

| Variable           | Tipus         | Descripció                                                                                                        |
|--------------------|---------------|-------------------------------------------------------------------------------------------------------------------|
| NO_FUGITS          | Numèrica      | Nombre de vehicles fugits implicats en l'accident                                                                 |
: Llistat de variables definides a posteriori per a la taula Persones

```{r}
# Ajuntem l'accident amb els vehicles
query3 <- sqldf("SELECT accidents.*, SUM(HIT_RUN) AS NO_FUGITS
                        FROM accidents INNER JOIN  C 
                        ON accidents.ST_CASE = C.ST_CASE
                GROUP BY accidents.ST_CASE, DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK,
                                 FATALS, DRUNK_DR
                HAVING HIT_RUN <> 9")

# Ajuntem l'accident amb les persones
query4 <- sqldf("SELECT query3.*, AGE, SEX, PER_TYP, DOA
                        FROM query3 INNER JOIN  B 
                        ON query3.ST_CASE = B.ST_CASE")
persones <- query4[,-1]
n <- nrow(persones)
persones <- data.frame(persones)
for(i in c(1, 4, 5, 13, 14, 15)) {
  persones[,i]<-as.factor(persones[,i])
}
```


# Preprocessament

La base de dades d'accidents està formada per `r nrow(accident)` casos (accidents) i `r ncol(accident)` variables. En canvi, la base de dades de persones la conformen `r nrow(persones)` individus (files) i `r ncol(persones)` variables (columnes).

Les variables que tenim són DAY, HOUR, MINUTE, RUR_URB, DAY_WEEK, FATALS, DRUNK_DR, NO_PER, MORTS, NO_VEHICLE, HIHAMORTS, NO_FUGITS, AGE, SEX, PERTYP i DOA.

## Missings

Per a poder tractar les dades mancants de la base de dades, en primer lloc haurem de tranformar-les, ja que les variables que presenten dades mancants les tenen codificades.

En el cas de les variables numèriques amb *missings*, que són l'edat (AGE), l'hora (HOUR), el minut (MINUTE) i la velocitat estimada del vehicle quan va tenir l'accident (TRAV_SP), les codificacions per aquestes dades són 99, 997, 998 o 999, depenent de cada cas.

```{r}
# Variable AGE
persones <- persones %>% replace_with_na(replace = list(AGE = c(998, 999)))

# Variable MINUTE
persones <- persones %>% replace_with_na(replace = list(MINUTE = c(99)))
accident <- accident %>% replace_with_na(replace = list(MINUTE = c(99)))

# Variable HOUR
persones <- persones %>% replace_with_na(replace = list(HOUR = c(98, 99)))
accident <- accident %>% replace_with_na(replace = list(HOUR = c(98, 99)))
```

Un cop transformades aquestes dades, podem visualitzar a la taula següent els *missings* per cada variable numèrica, tant en terme absolut com relatiu. A la taula següent s'hi poden trobar les variables de les bases de dades d'accidents i de persones, respectivament, juntament amb el nombre de dades mancants que presenten, i el tant per cent que aquestes suposen al total de la informació de la variable.

```{r, out.width = "50%", results='asis'}
propmiss <- function(dataframe) lapply(dataframe,function(x) data.frame(na = sum(is.na(x)),
                    n = length(x),  propNA = round(sum(is.na(x))/length(x),4) * 100))

missingsa <- propmiss(accident)
missingsa <- do.call(rbind.data.frame, missingsa)
missingsa <- missingsa[,-2]
colnames(missingsa) <- c("NA","Percentatge de NA")

missingsp <- propmiss(persones)
missingsp <- do.call(rbind.data.frame, missingsp)
missingsp <- missingsp[,-2]
colnames(missingsp) <- c("NA","Percentatge de NA")


knitr::kables(
  list(
    knitr::kable(missingsa), 
    knitr::kable(missingsp)), 
  caption = "Percentatge de missings per variable", format="latex")
```

Tal i com es pot observar, a la base de dades d'accidents s'hi troben *missings* per a les variables `HOUR` i `MINUTES`, mentre que per a la base de dades de persones, s'hi troben missings per a les variables `HOUR`, `MINUTES` i `AGE`. En ambdós casos, totes les variables són numèriques i, per aquest motiu es pot usar l'algoritme KNN per a la imputació de valors a les dades mancants.

*K-nearest neighbors* (KNN) és un tipus d'algoritme d'aprenentatge supervisat que s'utilitza tant per a la regressió com per a la classificació. La seva funció és intentar predir la classe correcta per a unes dades de prova (que, en el nostre cas, seran les variables que presenten dades mancants) en base a la seva similitut amb altres mostres de dades conegudes (en el nostre cas, les variables completes). Tot això es fa assumint que les dades amb trets similars es troben juntess, i utilitza mesures de distància en el seu nucli.

```{r include=FALSE}
library(class)
fullVariables<-c(6,7,8,9,10)
aux<-accident[,fullVariables]
var_num_incompletes <- c(2,3)
for (k in var_num_incompletes){
  aux1 <- aux[!is.na(accident[,k]),]
  dim(aux1) 
  aux2 <- aux[is.na(accident[,k]),]
  dim(aux2)
  
  RefValues<- accident[!is.na(accident[,k]),k]
  
  knn.values = knn(aux1,aux2,RefValues)   
  accident[is.na(accident[,k]),k] = as.numeric(as.character(knn.values))
  fullVariables<-c(fullVariables, k)
  aux<-accident[,fullVariables]
}
```

```{r include=FALSE}
library(class)
fullVariables<-c(6,7,8,9,10,11)
aux<-persones[,fullVariables]
var_num_incompletes <- c(2,3,12)
for (k in var_num_incompletes){
  aux1 <- aux[!is.na(persones[,k]),]
  dim(aux1) 
  aux2 <- aux[is.na(persones[,k]),]
  dim(aux2)
  
  RefValues<- persones[!is.na(persones[,k]),k]
  
  knn.values = knn(aux1,aux2,RefValues)   
  persones[is.na(persones[,k]),k] = as.numeric(as.character(knn.values))
  fullVariables<-c(fullVariables, k)
  aux<-persones[,fullVariables]
}
```

Un cop s'ha aplicat l'algoritme per a les variables corresponents, es pot veure, a continuació, com cap de les dues bases de dades presenta cap missing a les variables conflictives.

Recordem que la taula mostra les bases de dades d'accidents i de les persones implicades en els accidents, respectivament:

```{r, out.width = "50%", results='asis'}

propmiss <- function(dataframe) lapply(dataframe,function(x) data.frame(na = sum(is.na(x)),
                    n = length(x),  propNA = round(sum(is.na(x))/length(x),4) * 100))

missingsa <- propmiss(accident[,c(2,3)])
missingsa <- do.call(rbind.data.frame, missingsa)
missingsa <- missingsa[,-2]
colnames(missingsa) <- c("NA","Percentatge de NA")

missingsp <- propmiss(persones[c(2,3,12)])
missingsp <- do.call(rbind.data.frame, missingsp)
missingsp <- missingsp[,-2]
colnames(missingsp) <- c("NA","Percentatge de NA")

knitr::kables(
  list(
    knitr::kable(
           missingsa), 
    knitr::kable(
           missingsp)
    ), 
  caption = "Percentatge de missings per variable després del KNN", format="latex") %>%
  kable_styling(latex_options = "HOLD_position")

```

\pagebreak

## Outliers

```{r echo=FALSE}
descriptiva <- function(X, nom,dades){
  if (!(is.numeric(X) || class(X) == "Date")){ 
    frecs <- table(as.factor(X), useNA = "no"); proportions <- frecs/n
    dataf <- data.frame(x = levels(as.factor(X)), y = frecs)
    par(mfrow=c(1,2))
    print(ggplot(dataf, aes(x = "", y = frecs, fill = x)) + 
            geom_bar(stat = "identity", width = 1) + 
            scale_y_continuous(expand = c(0,0)) + coord_polar("y", start = 0) +
            scale_fill_brewer(palette = "YlGnBu") +
            theme_minimal())
    print(ggplot(dataf, aes(x = x, y=frecs)) + geom_bar(stat = "identity", 
          color = "#1d91c0", fill = "#1d91c0") + 
            scale_y_continuous(expand = c(0,0)) + theme_void())
    x <- data.frame(X)
    colnames(x) <- nom
    st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = FALSE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
    dfSummary(x) 

   }else{
      par(mfrow=c(1,2))
      print(ggplot(dades, aes(x = X)) + geom_bar(col = "#1d91c0", fill = 
      "#1d91c0") + theme_minimal())
#      print(ggplot(dades, aes(y = X)) + geom_boxplot(col = "#1d91c0", outlier.colour="red", outlier.shape=8,
#       outlier.size=4) + theme_minimal())
       a <- descr(X, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", 
                 "mean", "sd", "q3", "max", "iqr"), style = "rmarkdown", justify 
                 = "center")
       rownames(a) <- NULL
       kable(a, caption = paste("Resum numèric de la variable", nom), 
             format = "latex", position = "h!")
   }
}
```

Pel que fa a les dades atípiques, en destaca el nombre de persones implicades a l'accident. Més específicament, hi ha un cas en que 53 persones estan involucrades en un accident. A priori, res ens fa pensar que aquesta dada, tot i ser atípica, sigui certa. Això no obstant, a l'hora de la segmentació les dades es podrien veure afectades per aquest valor, ja que alguns algoritmes són molt sensibles a les dades atípiques.

A la següent figura es representa la variable nombre de persones (NO_PER), on es poden identificar de forma clara aquests valors atípics:

```{r, out.width="50%", fig.cap= "Histograma de la variable Nombre de persones", results='asis'}
#par(mfrow=c(1,2))
descriptiva(persones[,8], "Nombre de persones", dades = persones)
```

Per tal d'assegurar-nos que aquesta dada no afecta al nostre anàlisi, i tenint en compte que disposem d'una base de dades molt gran, treurem aquests casos d'ambdues baeses de dades.

```{r, echo=FALSE, include=FALSE}
persones <- persones[persones[,8] != 53,] 
accident <- accident[accident[,8] != 53,]
```

```{r, out.width="50%", fig.cap= "Histograma de la variable Nombre de persones després d'eliminar l'outlier", results='asis'}
#par(mfrow=c(1,2))
descriptiva(persones[,8], "Nombre de persones", dades = persones)
```


## Categoritzar

En el cas de les dades mancants que es troben en variables categòriques, el que es farà serà factoritzar-les i, seguidament, definir els nivells que presenta el factor. Així, per exemple, la variable **PER_TYP** presenta $8$ nivells que s'han d'agrupar en $3$ (*Conductor*, *Ocupant* i *Altres*). 

A continuació es mostren els canvis realitzats a algunes de les variables categòriques de la base de dades:

**PER_TYP**: Tipus de persona (1 = conductor, 2 = ocupant, resta de codis = altres).

```{r}
ab <- levels(persones$PER_TYP)

levels(persones$PER_TYP) <- c("Conductor", "Ocupant", "Altres", "Altres", "Altres", 
                        "Altres", "Altres", "Altres")
de <- levels(persones$PER_TYP)
```

- Abans: `r ab`

- Després: `r de`

**DAY_WEEK**: Dia de la setmana (1 = Diumenge, 2 = Dilluns, . . . , 7 = Dissabte).

```{r}
ab <- levels(persones$DAY_WEEK)

levels(persones$DAY_WEEK) <- c("Diumenge", "Dilluns", "Dimarts", "Dimecres", "Dijous",
                         "Divendres", "Dissabte")
levels(accident$DAY_WEEK) <- c("Diumenge", "Dilluns", "Dimarts", "Dimecres", "Dijous",
                         "Divendres", "Dissabte")

de <- levels(persones$DAY_WEEK)
```

- Abans: `r ab`

- Després: `r de`

**SEX**: Sexe de la persona (1 = home, 2 = dona, 8 = No registrat, 9 = Desconegut).

```{r}
ab <- levels(persones$SEX)

levels(persones$SEX) <- c("Home", "Dona", "Desconegut", "Desconegut")
de <- levels(persones$SEX)
```

- Abans: `r ab`

- Després: `r de`

Per la variable variable `SEX` hi ha una categoria anomenada "Desconegut", que representa aquelles persones de les quals no tenim informació del seu sexe. Com aquesta categoria no ens aporta informació d'utilitat a l'hora de realitzar l'estudi ni per a relitzar models predictius, prescindirem dels individus que corresponguin aquesta categoria per a realitzar el nostre anàlisi.

```{r, echo=FALSE, include=FALSE}
persones <- persones[persones$SEX != "Desconegut",] 
persones$SEX <- droplevels(persones$SEX)
```

**RUR_URB**: Informació sobre la localització (1 = Rural, 2 = Urbà, 6 = Via no classificada, 8 = No registrat, 9 = Desconegut). 

```{r}
ab <- levels(persones$RUR_URB)

levels(persones$RUR_URB) <- c("Rural", "Urbà", "Desconegut", 
                        "Desconegut", "Desconegut")
levels(accident$RUR_URB) <- c("Rural", "Urbà", "Desconegut", 
                        "Desconegut", "Desconegut")

de <- levels(persones$RUR_URB)
```

- Abans: `r ab`

- Després: `r de`

**HI HA MORTS**: Variable identificadora dels accidents mortals (0: no hi ha morts en l'accident, 1: hi ha morts en l'accident).

```{r}
ab <- levels(accident$HIHAMORTS)

levels(accident$HIHAMORTS) <- c("No", "Sí")

de <- levels(accident$HIHAMORTS)
```

- Abans: `r ab`

- Després: `r de`

**DOA**: Tipus de víctima (0 = sobreviu, 7 = mort a l’accident, 8 = mort al trasllat, 9 = Desconegut)

```{r}
ab <- levels(persones$DOA)

levels(persones$DOA) <- c("Sobreviu", "Mor", "Mor", "Desconegut")

de <- levels(persones$DOA)
```

- Abans: `r ab`

- Després: `r de`

Per aquesta última variable, `DOA`, hi ha una categoria anomenada "Desconegut", que representa aquelles persones que no se sap si sobreviuen a l'accident o no. Ja que en aquest estudi el fet de sobreviure o no a l'accident és de gran interès, i aquesta categoria  no ens aporta informació útil, prescindirem dels individus enmarcats en aquesta categoria per a realitzar el nostre anàlisi.

```{r, echo=FALSE, include=FALSE}
persones <- persones[persones$DOA != "Desconegut",] 
persones$DOA <- droplevels(persones$DOA)
```


```{r}
lev <- c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", 
         "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25",
         "26", "27", "28", "29", "30", "31")
persones$DAY <- factor(persones$DAY, levels = lev)
accident$DAY <- factor(accident$DAY, levels = lev)
```

**HOURS_agrupat**

```{r}
accident$HOUR_agrupat<- as.factor(accident$HOUR)
levels(accident$HOUR_agrupat) <- c("Matinada","Matinada","Matinada", "Matinada", "Matinada", "Matinada", "Matí", "Matí", "Matí", "Matí", "Matí", "Matí", "Migdia", "Migdia","Migdia","Tarda","Tarda","Tarda","Tarda","Tarda", "Nit", "Nit", "Nit", "Nit", "Nit")

persones$HOUR_agrupat <- as.factor(persones$HOUR)
levels(persones$HOUR_agrupat) <- c("Matinada","Matinada","Matinada", "Matinada", "Matinada", "Matinada", "Matí", "Matí", "Matí", "Matí", "Matí", "Matí", "Migdia", "Migdia","Migdia","Tarda","Tarda","Tarda","Tarda","Tarda", "Nit", "Nit", "Nit", "Nit", "Nit")
```


**DIA_agrupat**

```{r}
accident$SETMANA <- accident$DAY
levels(accident$SETMANA) <- c("Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 5", "Setmana 5", "Setmana 5", "Setmana 5")

persones$SETMANA <- persones$DAY
levels(persones$SETMANA) <- c("Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 1", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 2", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 3", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 4", "Setmana 5", "Setmana 5", "Setmana 5", "Setmana 5")
```


## Variable resposta

Per últim, definirem les variables resposta per a cada base de dades, és a dir, aquelles característiques que ens interessa poder predir tant en els futurs accidents com en les pròximes persones que es vegin involucrades en aquests.

Per una banda, és d'interès classificar els accidents segons si aquests han ocasionat morts o bé no ha sigut el cas. D'aquesta manera, es podria crear un model de predicció que permeti establir si un accident serà mortal o no en el futur en funció de les característiques que presenti.

Per tant, la variable d'interès és `HIHAMORTS`, que es mostra a la següent figura.

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Hi ha morts", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(accident[,11], "Hi ha morts", dades = persones)
```

\pagebreak

Seguint aquesta línia, serà també de gran importància el tipus de víctima que esdevindran cadascuna de les persones implicades en un accident. En aquest cas, la variable d'interès serà `DOA`, de la qual es pot trobar un breu anàlisi descriptiu a la figuara següent.

```{r, out.width="50%", fig.cap= "Anàlisi descriptiu de la variable Tipus de víctima", fig.subcap=c("Pie plot", "Bar plot"), results='asis'}
par(mfrow=c(1,2))
descriptiva(persones[,15], "Tipus de víctima", dades = persones)
```


```{r, echo=FALSE}
write.csv(accident,"/Users/annasalazar/Documents/accidents_bd.csv", row.names = FALSE)
write.csv(persones,"/Users/annasalazar/Documents/persones_bd.csv", row.names = FALSE)
```


\pagebreak

# Anàlisi descriptiva univariant

## Variables numèriques 

### Variables vinculades als accidents

| Variable            | Tipus         | Descripció                                                                                                      |
|---------------------|---------------|------------------------------------------------------------------------------------------------------------------|
| HOUR               | Numèrica      | Hora de l’accident (99 = desconeguda)                                                                             |
| MINUTE             | Numèrica      | Minut de l’accident (99 = desconegut)                                                                             |
| FATALS             | Numèrica      | Nombre de ferits a l’accident                                                                                     |
| DRUNK_DR           | Numèrica      | Nombre de conductors beguts involucrats a l’accident                                                              |
| MORTS               | Numèrica      | Nombre de morts en l'accident                                                                                   |
| NO_PER              | Numèrica      | Nombre de persones implicades en l'accident                                                                     |
| NO_VEHICLE          | Numèrica      | Nombre de vehicles implicats en l'accident                                                                      |

: Variables numèriques vinculades als accidents


```{r, results='asis', echo=FALSE}
a1 <- descr(accident$HOUR, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a1) <- NULL

a2 <- descr(accident$MINUTE, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a2) <- NULL

a3 <- descr(accident$FATALS, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a3) <- NULL

a4 <- descr(accident$DRUNK_DR, transpose = TRUE, stats =  c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", 
                                                        "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a4) <- NULL

a5 <- descr(accident$MORTS, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", 
                                                       "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a5) <- NULL

a6 <- descr(accident$NO_PER, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a6) <- NULL

a7 <- descr(accident$NO_VEHICLE, transpose = TRUE, stats = 
             c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max", "iqr"),
           style = "rmarkdown", justify = "center")
rownames(a7) <- NULL

a <- rbind(a1,a2,a3,a4,a5,a6,a7)
Variable <- c("HOUR", "MINUTE", "FATALS", "DRUNK_DR", "NO_PER", "MORTS", "NO_VEHICLE")
a <- cbind(Variable,a)
kable(a, caption = "Resum de les variables numèriques vinculades als accidents", 
             format = "latex", position = "h!")
```

### Variables vinculades a les persones

| Variable            | Tipus         | Descripció                                                                                                      |
|---------------------|---------------|------------------------------------------------------------------------------------------------------------------|
| HOUR                | Numèrica      | Hora de l’accident (99 = desconeguda)                                                                            |
| MINUTE              | Numèrica      | Minut de l’accident                                                                                              |
| FATALS              | Numèrica      | Nombre de ferits a l’accident                                                                                    |
| DRUNK_DR            | Numèrica      | Nombre de conductors beguts involucrats a l’accident                                                              |
| MORTS               | Numèrica      | Nombre de morts en l'accident                                                                                    |
| NO_PER              | Numèrica      | Nombre de persones implicades en l'accident                                                                      |
| NO_VEHICLE          | Numèrica      | Nombre de vehicles implicats en l'accident                                                                       |
| NO_FUGITS           | Numèrica      | Nombre de vehicles fugits implicats en l'accident                                                                |
| AGE                 | Numèrica       | Edat de la persona                                                                                              |

: Variables numèriques vinculades a les persones
       
```{r, results='asis', echo=FALSE}
a1 <- descr(persones$HOUR, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a1) <- NULL

a2 <- descr(persones$MINUTE, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a2) <- NULL

a3 <- descr(persones$FATALS, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a3) <- NULL

a4 <- descr(persones$DRUNK_DR, transpose = TRUE, stats =  c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", 
                                                        "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a4) <- NULL

a5 <- descr(persones$MORTS, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", 
                                                       "max", "iqr"), style = "rmarkdown", justify = "center")
rownames(a5) <- NULL

a6 <- descr(persones$NO_PER, transpose = TRUE, stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max",
                                                       "iqr"), style = "rmarkdown", justify = "center")
rownames(a6) <- NULL

a7 <- descr(persones$NO_VEHICLE, transpose = TRUE, stats = 
             c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max", "iqr"),
           style = "rmarkdown", justify = "center")
rownames(a7) <- NULL

a8 <- descr(persones$NO_FUGITS, transpose = TRUE, stats = c("N.Valid", "min", "q1", 
                                                        "med", "mean", "sd", "q3", 
                                                        "max", "iqr"),
           style = "rmarkdown", justify = "center")
rownames(a8) <- NULL

a9 <- descr(persones$AGE, transpose = TRUE, stats = c("N.Valid", "min", "q1", 
                                                        "med", "mean", "sd", 
                                                        "q3", "max", "iqr"),
           style = "rmarkdown", justify = "center")
rownames(a9) <- NULL

a <- rbind(a1, a2, a3, a4, a5, a6, a7, a8, a9)
variable <- c("HOUR", "MINUTE", "FATALS", "DRUNK_DR", "NO_PER", "MORTS", "NO_VEHICLE", "NO_FUGITS", "EDAT")
a <- cbind(variable,a)
kable(a, caption = "Resum de les variables numèriques vinculades a les persones", 
             format = "latex", position = "h!")
```

\pagebreak


## Variables categòriques

### Variables vinculades als accidents

**DAY**: Dia de l’accident (de l’1 al 31). Tipus de variable: `r class(persones$DAY)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(accident[,1]) 
```

**RUR_URB**: Informació sobre la localització (1 = Rural, 2 = Urbà, 6 = Via no classificada, 8 = No registrat, 9 = Desconegut). Tipus de variable: `r class(persones$RUR_URB)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(accident[,4]) 
```

**DAY_WEEK**: Dia de la setmana (1 = Diumenge, 2 = Dilluns, . . . , 7 = Dissabte). Tipus de variable: `r class(persones$DAY_WEEK)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(accident[,5]) 
```

**HIHAMORTS**:

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(accident[,11]) 
```

### Variables vinculades a les persones

**SEX**: Sexe de la persona (1 = home, 2 = dona, 8 = No registrat, 9 = Desconegut). Tipus de variable: `r class(persones$SEX)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(persones[,13]) 
```

**PER_TYP**: Tipus de persona (1 = conductor, 2 = ocupant, resta de codis = altres). Tipus de variable: `r class(persones$PER_TYP)`

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(persones[,14]) 
```

**DOA**: Tipus de víctima (0 = sobreviu, 7 = mort a l’accident, 8 = mort al trasllat, 9 = Desconegut). Tipus de variable: `r class(persones$DOA)` 

```{r, results='asis', echo=FALSE}
st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA,
          style = 'grid', dfSummary.varnumbers = FALSE,
          dfSummary.valid.col = TRUE, tmp.img.dir  = "img", round.digits = 3,
          dfSummary.silent = TRUE, dfSummary.graph.col= FALSE)
dfSummary(persones[, 15]) 
```

\pagebreak


# Anàlisi descriptiva bivariant

### Variables vinculades als accidents

<center>

![Nombre de conductors beguts segons el dia de la setmana](~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph1.png){width="50%"}

</center>

Pel que fa al nombre de conductors beguts segons el dia de la setmana en el qual succeeix l'accident, s'observa de forma clara a la gràfica de dalt com la majoria dels conductors beguts es concentren al cap de setmana. Sembla que podria ser un patró perquè hi ha diferències notables entre la quantitat de conductor beguts a finals de la setmana, en comparació als dilluns, dimarts i dimecres.

<center>

![Quantitat d'accidents segons el dia de la setmana](~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph2.png){width="50%"}

</center> 

Si ens fixem, en aquest cas, en el nombre de morts segons el dia de la setmana, el dilluns es troba altre vegada en l'última posició, ja que és el dia en que es donen menys morts en accidents de trànsit. Paralel·lament, els últims dies de la setmana presenten un major nombre d'accidents mortals. Si es té en compte la informació d'aquests últims gràfics, es podria pensar que existeix una relació entre el nombre de conductors beguts i el nombre de ferits mortals als accidents de trànsit. S'haurà de tenir en compte aquesta hipòtesi per anàlisis posteriors de les dades.

<center>

![Nombre de morts segons l'hora en que es produeix l'accident](~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph6.png){width="50%"}

</center> 

Si centrem l'atenció en les hores del dia, 

<center>

![Nombre d'accidents segons el nombre de morts (hores)](~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph5.png){width="50%"}

</center> 

<center>

![Nombre de morts segons el nombre de conductor beguts els diferents dies de la setmana](~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph7.png){width="50%"}

</center> 

\pagebreak

### Variables vinculades a les persones

<center>

![Aquest no té molt sentit](~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph8.png){width="50%"}

</center> 

<center>

![Nombre de morts segons el nombre de conductor beguts a les diferents edats](~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph9.png){width="50%"}

</center> 

<center>

![Quantitat de supervivents segons el sexe](~/Documents/GitHub/TFG/Data Studio/Gràfics/Graph10.png){width="50%"}

</center> 
